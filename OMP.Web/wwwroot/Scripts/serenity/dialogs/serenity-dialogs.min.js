var Q;(function(t){var e;(function(e){var i;var n=0;var o=0;var a;var r=0;var l=0;e.enabled=true;function s(t,e){return t==e||t==e+"#"||e==t+"#"}function u(t,o,a){if(!e.enabled||n>0)return;t=t||"";t=t.replace(/^#/,"");t=!t?"":"#"+t;var r=window.location.href.replace(/#$/,"").replace(/#.*$/,"")+t;if(r!=window.location.href){if(o&&i!=null&&s(i,r)){if(a)v();var l=window.location.href;i=null;window.history.back();return}if(a)v();i=window.location.href;window.location.hash=t}}e.navigate=u;function d(t,e){u(t,e,true)}e.replace=d;function h(t,i){if(!e.enabled)return;var n=window.location.hash||"";if(n.charAt(0)=="#")n=n.substr(1,n.length-1);var o=n.split("/+/");if(o.length>1){if(t&&t.length){o[o.length-1]=t;t=o.join("/+/")}else{o.splice(o.length-1,1);t=o.join("/+/")}}d(t,i)}e.replaceLast=h;function c(){return $(".ui-dialog-content:visible, .ui-dialog.panel-hidden>.ui-dialog-content, .s-Panel").toArray().sort(function(t,e){return($(t).data("qrouterorder")||0)-($(e).data("qrouterorder")||0)})}function p(e,i,n){var o=[];var a=e.hasClass(".ui-dialog-content")||e.hasClass(".s-Panel");var r=a?e:e.closest(".ui-dialog-content, .s-Panel");var l=n();var s;if(r.length){var u=c();var p=u.indexOf(r[0]);for(var f=0;f<=p;f++){var g=$(u[f]).data("qroute");if(g&&g.length)o.push(g)}if(!a){s=r.attr("id");if(s){s+="_";var y=e.attr("id");if(y&&t.startsWith(y,s))l=y.substr(s.length)+"@"+l}}}else{var y=e.attr("id");if(y&&(!e.hasClass("route-handler")||$(".route-handler").first().attr("id")!=y))l=y+"@"+l}o.push(l);i.data("qroute",l);d(o.join("/+/"));i.bind("dialogclose.qrouter panelclose.qrouter",function(t){i.data("qroute",null);i.unbind(".qrouter");var e=i.data("qprhash");var n=$(t.target).closest(".s-MessageDialog").length>0||t&&t.originalEvent&&(t.originalEvent.type=="keydown"&&t.originalEvent.keyCode==27||$(t.originalEvent.target).hasClass("ui-dialog-titlebar-close")||$(t.originalEvent.target).hasClass("panel-titlebar-close"));if(e!=null)d(e,n);else h("",n)})}function f(t,i,n){if(!e.enabled)return;i.on("dialogopen.qrouter panelopen.qrouter",function(e){p(t,i,n)})}e.dialog=f;function g(i){if(!e.enabled)return;n++;try{i=t.coalesce(t.coalesce(i,window.location.hash),"");if(i.charAt(0)=="#")i=i.substr(1,i.length-1);var o=c();var a=i.split("/+/");var r=o.map(function(t){return $(t).data("qroute")});var l=0;while(l<o.length&&l<a.length&&r[l]==a[l]){l++}for(var s=l;s<o.length;s++){var u=$(o[s]);if(u.hasClass("ui-dialog-content"))u.dialog("close");else if(u.hasClass("s-Panel"))Serenity.TemplatedDialog.closePanel(u)}for(var s=l;s<a.length;s++){var d=a[s];var h=d.split("@");var p;if(h.length==2){var f=s>0?$(o[s-1]):$([]);if(f.length){var g=f.attr("id");if(g){p=$("#"+g+"_"+h[0]);if(p.length){d=h[1]}}}if(!p||!p.length){p=$("#"+h[0]);if(p.length){d=h[1]}}}if(!p||!p.length){p=s>0?$(o[s-1]):$(".route-handler").first()}p.triggerHandler("handleroute",{handled:false,route:d,parts:a,index:s})}}finally{n--}}e.resolve=g;function y(t,e){if(r>0){if((new Date).getTime()-l>1e3){r=0}else{r--;return}}g()}function v(){r++;l=(new Date).getTime()}window.addEventListener("hashchange",y,false);var m=1;$(document).on("dialogopen panelopen",".ui-dialog-content, .s-Panel",function(t,i){if(!e.enabled)return;var n=$(t.target);n.data("qrouterorder",m++);if(n.data("qroute"))return;n.data("qprhash",window.location.hash);var a=$(c).not(n).last();if(!a.length)a=$("html");p(a,n,function(){return"!"+(++o).toString(36)})})})(e=t.Router||(t.Router={}))})(Q||(Q={}));var Q;(function(t){function e(t){t.css("height","100%");r(t)}t.autoFullHeight=e;function i(e){$("body").addClass("full-height-page");e.addClass("responsive-height");var i=function(){var t=e.parent().hasClass("page-content")||e.parent().is("section.content");if(t){e.css("height","1px").css("overflow","hidden")}o(e);if(t){e.css("overflow","")}e.triggerHandler("layout")};if($("body").hasClass("has-layout-event")){$("body").bind("layout",i)}else if(window.Metronic){window.Metronic.addResizeHandler(i)}else{$(window).resize(i)}i();e.one("remove",function(){$(window).off("layout",i);$("body").off("layout",i)});t["Router"]&&t["Router"].resolve&&t["Router"].resolve()}t.initFullHeightGridPage=i;function n(t){var e=0;t.parent().children().not(t).each(function(t,i){var n=$(i);if(n.is(":visible")){e+=n.outerHeight(true)}});e=t.parent().height()-e;if(t.css("box-sizing")!=="border-box"){e=e-(t.outerHeight(true)-t.height())}return e}t.layoutFillHeightValue=n;function o(t){var e=n(t);var i=Math.round(e)+"px";if(t.css("height")!=i){t.css("height",i)}}t.layoutFillHeight=o;function a(){var t=navigator.userAgent.indexOf("Mobi")>=0||window.matchMedia&&window.matchMedia("(max-width: 767px)").matches;var e=$(document.body);if(e.hasClass("mobile-device")){if(!t){e.removeClass("mobile-device")}}else if(t){e.addClass("mobile-device")}}t.setMobileDeviceMode=a;a();$(function(){if(globalObj&&t.Config.rootNamespaces){for(var e=0,i=t.Config.rootNamespaces;e<i.length;e++){var n=i[e];var o=t.getNested(globalObj,n);if(o!=null)t.initializeTypes(o,n+".",3)}}globalObj&&$(globalObj).bind("resize",function(){a()})});function r(t){Serenity.LazyLoadHelper.executeEverytimeWhenShown(t,function(){t.triggerHandler("layout")},true)}t.triggerLayoutOnShow=r;function l(t){if(!t.hasClass("ui-dialog"))t=t.closest(".ui-dialog");t.position({at:"center center",of:window});var e=t.position();if(e.left<0)t.css("left","0px");if(e.top<0)t.css("top","0px")}t.centerDialog=l})(Q||(Q={}));var Serenity;(function(t){var e;(function(t){function e(t,e,i,n,o){var a=t.dialog();a.dialog("option","resizable",true);if(n!=null){a.dialog("option","minWidth",n)}if(e!=null){a.dialog("option","width",e)}if(o!=null){a.dialog("option","minHeight",o)}if(i!=null){a.dialog("option","height",i)}return t}t.dialogResizable=e;function i(t){t.dialogExtend({closable:true,maximizable:true,dblclick:"maximize",icons:{maximize:"ui-icon-maximize-window"}});return t}t.dialogMaximizable=i})(e=t.DialogExtensions||(t.DialogExtensions={}))})(Serenity||(Serenity={}));var Serenity;(function(t){var e=function(e){__extends(i,e);function i(t){var i=e.call(this,Q.newBodyDiv().addClass("s-TemplatedDialog hidden"),t)||this;i.element.attr("id",i.uniqueName);i.initValidator();i.initTabs();i.initToolbar();return i}n=i;Object.defineProperty(i.prototype,"isMarkedAsPanel",{get:function(){var e=Q.getAttributes(Q.getInstanceType(this),t.PanelAttribute,true);return e.length>0&&e[e.length-1].value!==false},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"isResponsive",{get:function(){return Q.Config.responsiveDialogs||Q.getAttributes(Q.getInstanceType(this),t.ResponsiveAttribute,true).length>0},enumerable:true,configurable:true});i.getCssSize=function(t,e){var i=t.css(e);if(i==null){return null}if(!Q.endsWith(i,"px")){return null}i=i.substr(0,i.length-2);var n=Q.parseInteger(i);if(n==null||isNaN(n)||n==0)return null;return n};i.applyCssSizes=function(t,e){var i;var o=$("<div/>").hide().addClass(e).appendTo(document.body);try{var a=$("<div/>").addClass("size").appendTo(o);i=n.getCssSize(a,"minWidth");if(i!=null)t.minWidth=i;i=n.getCssSize(a,"width");if(i!=null)t.width=i;i=n.getCssSize(a,"height");if(i!=null)t.height=i;i=n.getCssSize(a,"minHeight");if(i!=null)t.minHeight=i}finally{o.remove()}};i.prototype.destroy=function(){this.tabs&&this.tabs.tabs("destroy");this.tabs=null;this.toolbar&&this.toolbar.destroy();this.toolbar=null;this.validator&&this.byId("Form").remove();this.validator=null;if(this.element!=null&&this.element.hasClass("ui-dialog-content")){this.element.dialog("destroy");this.element.removeClass("ui-dialog-content")}else if(this.element!=null&&this.element.hasClass("modal-body")){var t=this.element.closest(".modal").data("bs.modal",null);this.element&&this.element.removeClass("modal-body");window.setTimeout(function(){return t.remove()},0)}$(window).unbind("."+this.uniqueName);e.prototype.destroy.call(this)};i.prototype.initDialog=function(){var e=this;if(this.element.hasClass("ui-dialog-content"))return;this.element.removeClass("hidden");this.element.dialog(this.getDialogOptions());this.element.closest(".ui-dialog").on("resize",function(t){return e.arrange()});var i=Q.getInstanceType(this);if(this.isResponsive){t.DialogExtensions.dialogResizable(this.element);$(window).bind("resize."+this.uniqueName,function(t){if(e.element&&e.element.is(":visible")){e.handleResponsive()}});this.element.closest(".ui-dialog").addClass("flex-layout")}if(Q.getAttributes(i,t.MaximizableAttribute,true).length>0){t.DialogExtensions.dialogMaximizable(this.element)}var n=this;this.element.bind("dialogopen."+this.uniqueName,function(){$(document.body).addClass("modal-dialog-open");if(e.isResponsive){e.handleResponsive()}n.onDialogOpen()});this.element.bind("dialogclose."+this.uniqueName,function(){$(document.body).toggleClass("modal-dialog-open",$(".ui-dialog:visible").length>0);n.onDialogClose()})};i.prototype.getModalOptions=function(){return{backdrop:false,keyboard:false,size:"lg",modalClass:this.getCssClass()}};i.prototype.initModal=function(){var t=this;if(this.element.hasClass("modal-body"))return;var e=Q.coalesce(this.element.data("dialogtitle"),this.getDialogTitle())||"";var i=this.getModalOptions();i["show"]=false;var n="s-Modal";if(i.modalClass)n+=" "+i.modalClass;var o=Q.bsModalMarkup(e,"",n);var a=$(o).eq(0).appendTo(document.body).addClass("flex-layout");a.one("shown.bs.modal."+this.uniqueName,function(){t.element.triggerHandler("shown.bs.modal");t.onDialogOpen()});a.one("hidden.bs.modal."+this.uniqueName,function(){$(document.body).toggleClass("modal-open",$(".modal.show").length+$(".modal.in").length>0);t.onDialogClose()});if(i.size)a.find(".modal-dialog").addClass("modal-"+i.size);var r=a.find(".modal-footer");var l=this.getDialogButtons();if(l!=null){for(var s=0,u=l;s<u.length;s++){var d=u[s];$(Q.dialogButtonToBS(d)).appendTo(r).click(d.click)}}else r.hide();a.modal(i);a.find(".modal-body").replaceWith(this.element.removeClass("hidden").addClass("modal-body"));$(window).on("resize."+this.uniqueName,this.arrange.bind(this))};i.prototype.initToolbar=function(){var e=this.byId("Toolbar");if(e.length===0){return}var i=this.element.closest(".ui-dialog");if(i.length===0){i=this.element.closest(".modal");if(i.length==0)i=this.element}var n={buttons:this.getToolbarButtons(),hotkeyContext:i[0]};this.toolbar=new t.Toolbar(e,n)};i.prototype.getToolbarButtons=function(){return[]};i.prototype.getValidatorOptions=function(){return{}};i.prototype.initValidator=function(){var t=this.byId("Form");if(t.length>0){var e=this.getValidatorOptions();this.validator=t.validate(Q.validateOptions(e))}};i.prototype.resetValidation=function(){this.validator&&this.validator.resetAll()};i.prototype.validateForm=function(){return this.validator==null||!!this.validator.form()};i.prototype.dialogOpen=function(t){var e=this;t=Q.coalesce(t,this.isMarkedAsPanel);if(t){if(!this.element.hasClass("s-Panel")){this.element.on("panelopen."+this.uniqueName,function(){e.onDialogOpen()});this.element.on("panelclose."+this.uniqueName,function(){e.onDialogClose()})}n.openPanel(this.element,this.uniqueName);this.setupPanelTitle()}else if(this.useBSModal()){this.initModal();this.element.closest(".modal").modal("show")}else{this.initDialog();this.element.dialog("open")}};i.prototype.useBSModal=function(){return!!(!$.ui||!$.ui.dialog||n.bootstrapModal)};i.openPanel=function(t,e){var i=$(".panels-container");if(!i.length)i=$("section.content");t.data("paneluniquename",e);if(i.length){i=i.last();i.children().not(t).not(".panel-hidden").addClass("panel-hidden panel-hidden-"+e);if(t[0].parentElement!==i[0])t.appendTo(i)}$(".ui-dialog:visible, .ui-widget-overlay:visible, .modal.show, .modal.in").not(t).addClass("panel-hidden panel-hidden-"+e);t.removeClass("hidden").removeClass("panel-hidden").addClass("s-Panel").trigger("panelopen")};i.closePanel=function(t,e){if(!t.hasClass("s-Panel")||t.hasClass("hidden"))return;var i=$.Event(e);i.type="panelbeforeclose";i.target=t[0];t.trigger(i);if(i.isDefaultPrevented())return;t.addClass("hidden");var n=t.data("paneluniquename")||(new Date).getTime();var o="panel-hidden-"+n;$("."+o).removeClass(o).removeClass("panel-hidden");$(window).triggerHandler("resize");$(".require-layout:visible").triggerHandler("layout");var e=$.Event(e);e.type="panelclose";e.target=t[0];t.trigger(e)};i.prototype.onDialogOpen=function(){if(!$(document.body).hasClass("mobile-device"))$(":input",this.element).not("button").eq(0).focus();this.arrange();this.tabs&&this.tabs.tabs("option","active",0)};i.prototype.arrange=function(){this.element.find(".require-layout").filter(":visible").each(function(t,e){$(e).triggerHandler("layout")})};i.prototype.onDialogClose=function(){var t=this;$(document).trigger("click");if($.qtip){$(document.body).children(".qtip").each(function(t,e){$(e).qtip("hide")})}window.setTimeout(function(){var e=t.element;t.destroy();e.remove();Q.positionToastContainer(false)},0)};i.prototype.addCssClass=function(){if(this.isMarkedAsPanel){e.prototype.addCssClass.call(this);if(this.isResponsive)this.element.addClass("flex-layout")}};i.prototype.getDialogButtons=function(){return undefined};i.prototype.getDialogOptions=function(){var e={};var i="s-Dialog "+this.getCssClass();e.dialogClass=i;var o=this.getDialogButtons();if(o!=null)e.buttons=o.map(Q.dialogButtonToUI);e.width=920;n.applyCssSizes(e,i);e.autoOpen=false;var a=Q.getInstanceType(this);e.resizable=Q.getAttributes(a,t.ResizableAttribute,true).length>0;e.modal=true;e.position={my:"center",at:"center",of:$(window.window)};e.title=Q.coalesce(this.element.data("dialogtitle"),this.getDialogTitle())||"";return e};i.prototype.getDialogTitle=function(){return""};i.prototype.dialogClose=function(){if(this.element.hasClass("ui-dialog-content"))this.element.dialog().dialog("close");else if(this.element.hasClass("modal-body"))this.element.closest(".modal").modal("hide");else if(this.element.hasClass("s-Panel")&&!this.element.hasClass("hidden")){n.closePanel(this.element)}};Object.defineProperty(i.prototype,"dialogTitle",{get:function(){if(this.element.hasClass("ui-dialog-content"))return this.element.dialog("option","title");else if(this.element.hasClass("modal-body"))return this.element.closest(".modal").find(".modal-header").children("h5").text();return this.element.data("dialogtitle")},set:function(t){var e=this.dialogTitle;this.element.data("dialogtitle",t);if(this.element.hasClass("ui-dialog-content"))this.element.dialog("option","title",t);else if(this.element.hasClass("modal-body")){this.element.closest(".modal").find(".modal-header").children("h5").text(t!==null&&t!==void 0?t:"")}else if(this.element.hasClass("s-Panel")){if(e!=this.dialogTitle){this.setupPanelTitle();this.arrange()}}},enumerable:true,configurable:true});i.prototype.setupPanelTitle=function(){var t=this;var e=Q.coalesce(this.dialogTitle,this.getDialogTitle());var i=this.element.children(".panel-titlebar");if(Q.isEmptyOrNull(e)){i.remove()}else{if(!this.element.children(".panel-titlebar").length){i=$("<div class='panel-titlebar'><div class='panel-titlebar-text'></div></div>").prependTo(this.element)}i.children(".panel-titlebar-text").text(e);if(this.element.hasClass("s-Panel")){if(!i.children(".panel-titlebar-close").length){$('<button class="panel-titlebar-close">&nbsp;</button>').prependTo(i).click(function(e){n.closePanel(t.element,e)})}}}};i.prototype.set_dialogTitle=function(t){this.dialogTitle=t};i.prototype.initTabs=function(){var t=this;var e=this.byId("Tabs");if(e.length===0){return}this.tabs=e.tabs({});this.tabs.bind("tabsactivate",function(){return t.arrange()})};i.prototype.handleResponsive=function(){var t=this.element.dialog();var e=this.element.closest(".ui-dialog");if($(document.body).hasClass("mobile-device")){var i=this.element.data("responsiveData");if(!i){i={};i.draggable=t.dialog("option","draggable");i.resizable=t.dialog("option","resizable");i.position=t.css("position");var n=e.position();i.left=n.left;i.top=n.top;i.width=e.width();i.height=e.height();i.contentHeight=this.element.height();this.element.data("responsiveData",i);t.dialog("option","draggable",false);t.dialog("option","resizable",false)}e.addClass("mobile-layout");e.css({left:"0px",top:"0px",width:$(window).width()+"px",height:$(window).height()+"px",position:"fixed"});$(document.body).scrollTop(0);Q.layoutFillHeight(this.element)}else{var o=this.element.data("responsiveData");if(o){t.dialog("option","draggable",o.draggable);t.dialog("option","resizable",o.resizable);this.element.closest(".ui-dialog").css({left:"0px",top:"0px",width:o.width+"px",height:o.height+"px",position:o.position});this.element.height(o.contentHeight);e.removeClass("mobile-layout");this.element.removeData("responsiveData")}}};var n;i=n=__decorate([t.Decorators.registerClass([t.IDialog])],i);return i}(t.TemplatedWidget);t.TemplatedDialog=e})(Serenity||(Serenity={}));var Serenity;(function(t){var e=function(e){__extends(i,e);function i(t){var i=e.call(this,t)||this;i.initPropertyGrid();i.loadInitialEntity();return i}i.prototype.destroy=function(){if(this.propertyGrid){this.propertyGrid.destroy();this.propertyGrid=null}if(this.validator){this.byId("Form").remove();this.validator=null}e.prototype.destroy.call(this)};i.prototype.getDialogOptions=function(){var t=e.prototype.getDialogOptions.call(this);t.width=400;return t};i.prototype.getDialogButtons=function(){var t=this;return[{text:Q.text("Dialogs.OkButton"),click:function(){return t.okClick()}},{text:Q.text("Dialogs.CancelButton"),click:function(){return t.cancelClick()}}]};i.prototype.okClick=function(){if(!this.validateBeforeSave()){return}this.okClickValidated()};i.prototype.okClickValidated=function(){this.dialogClose()};i.prototype.cancelClick=function(){this.dialogClose()};i.prototype.initPropertyGrid=function(){var e=this.byId("PropertyGrid");if(e.length<=0){return}var i=this.getPropertyGridOptions();this.propertyGrid=new t.PropertyGrid(e,i).init(null);if(this.element.closest(".ui-dialog").hasClass("s-Flexify")){this.propertyGrid.element.children(".categories").flexHeightOnly(1)}};i.prototype.getFormKey=function(){var e=Q.getAttributes(Q.getInstanceType(this),t.FormKeyAttribute,true);if(e.length>=1){return e[0].value}else{var i=Q.getTypeFullName(Q.getInstanceType(this));var n=i.indexOf(".");if(n>=0){i=i.substring(n+1)}if(Q.endsWith(i,"Dialog")){i=i.substr(0,i.length-6)}else if(Q.endsWith(i,"Panel")){i=i.substr(0,i.length-5)}return i}};i.prototype.getPropertyGridOptions=function(){return{idPrefix:this.idPrefix,items:this.getPropertyItems(),mode:1,useCategories:false,localTextPrefix:"Forms."+this.getFormKey()+"."}};i.prototype.getPropertyItems=function(){var t=this.getFormKey();return Q.getForm(t)};i.prototype.getSaveEntity=function(){var t=new Object;if(this.propertyGrid){this.propertyGrid.save(t)}return t};i.prototype.loadInitialEntity=function(){this.propertyGrid&&this.propertyGrid.load(new Object)};i.prototype.get_entity=function(){return this._entity};i.prototype.set_entity=function(t){this._entity=Q.coalesce(t,new Object)};i.prototype.get_entityId=function(){return this._entityId};i.prototype.set_entityId=function(t){this._entityId=t};i.prototype.validateBeforeSave=function(){return this.validator.form()};i.prototype.updateTitle=function(){};i=__decorate([t.Decorators.registerClass("Serenity.PropertyDialog")],i);return i}(t.TemplatedDialog);t.PropertyDialog=e})(Serenity||(Serenity={}));var Serenity;(function(t){var e=function(e){__extends(i,e);function i(t){var i=e.call(this,t)||this;i.initPropertyGrid();i.initLocalizationGrid();return i}i.prototype.destroy=function(){if(this.propertyGrid){this.propertyGrid.destroy();this.propertyGrid=null}if(this.localizationGrid){this.localizationGrid.destroy();this.localizationGrid=null}this.undeleteButton=null;this.applyChangesButton=null;this.deleteButton=null;this.saveAndCloseButton=null;this.editButton=null;this.cloneButton=null;this.toolbar=null;e.prototype.destroy.call(this)};i.prototype.get_entity=function(){return this.entity};i.prototype.set_entity=function(t){this.entity=t||new Object};i.prototype.get_entityId=function(){return this.entityId};i.prototype.set_entityId=function(t){this.entityId=t};i.prototype.getEntityNameFieldValue=function(){return Q.coalesce(this.get_entity()[this.getNameProperty()],"").toString()};i.prototype.getEntityTitle=function(){if(!this.isEditMode()){return Q.format(Q.text("Controls.EntityDialog.NewRecordTitle"),this.getEntitySingular())}else{var t=this.isViewMode()||this.readOnly||!this.hasSavePermission()?Q.text("Controls.EntityDialog.ViewRecordTitle"):Q.text("Controls.EntityDialog.EditRecordTitle");var e=Q.coalesce(this.getEntityNameFieldValue(),"");return Q.format(t,this.getEntitySingular(),Q.isEmptyOrNull(e)?"":" ("+e+")")}};i.prototype.updateTitle=function(){this.dialogTitle=this.getEntityTitle()};i.prototype.isCloneMode=function(){return false};i.prototype.isEditMode=function(){return this.get_entityId()!=null&&!this.isCloneMode()};i.prototype.isDeleted=function(){if(this.get_entityId()==null){return false}var t=this.getIsDeletedProperty();if(t){return!!this.get_entity()[t]}var e=this.get_entity()[this.getIsActiveProperty()];if(e==null){return false}return e<0};i.prototype.isNew=function(){return this.get_entityId()==null};i.prototype.isNewOrDeleted=function(){return this.isNew()||this.isDeleted()};i.prototype.getDeleteOptions=function(t){return{}};i.prototype.deleteHandler=function(t,e){Q.serviceCall(t)};i.prototype.doDelete=function(t){var e=this;var i=this;var n={EntityId:this.get_entityId()};var o={service:this.getService()+"/Delete",request:n,onSuccess:function(o){i.onDeleteSuccess(o);if(t!=null){t(o)}i.element.triggerHandler("ondatachange",[{entityId:n.EntityId,entity:e.entity,type:"delete"}])}};var a=this.getDeleteOptions(t);var r=Q.extend(o,a);this.deleteHandler(r,t)};i.prototype.onDeleteSuccess=function(t){};i.prototype.attrs=function(t){return Q.getAttributes(Q.getInstanceType(this),t,true)};i.prototype.getEntityType=function(){if(this.entityType!=null)return this.entityType;var e=this.attrs(t.EntityTypeAttribute);if(e.length===1)return this.entityType=e[0].value;var i=Q.getTypeFullName(Q.getInstanceType(this));var n=i.indexOf(".");if(n>=0)i=i.substring(n+1);if(Q.endsWith(i,"Dialog")||Q.endsWith(i,"Control"))i=i.substr(0,i.length-6);else if(Q.endsWith(i,"Panel"))i=i.substr(0,i.length-5);return this.entityType=i};i.prototype.getFormKey=function(){if(this.formKey!=null)return this.formKey;var e=this.attrs(t.FormKeyAttribute);if(e.length>=1)return this.formKey=e[0].value;return this.formKey=this.getEntityType()};i.prototype.getLocalTextDbPrefix=function(){if(this.localTextDbPrefix!=null)return this.localTextDbPrefix;this.localTextDbPrefix=Q.coalesce(this.getLocalTextPrefix(),"");if(this.localTextDbPrefix.length>0&&!Q.endsWith(this.localTextDbPrefix,"."))this.localTextDbPrefix="Db."+this.localTextDbPrefix+".";return this.localTextDbPrefix};i.prototype.getLocalTextPrefix=function(){var e=this.attrs(t.LocalTextPrefixAttribute);if(e.length>=1)return e[0].value;return this.getEntityType()};i.prototype.getEntitySingular=function(){if(this.entitySingular!=null)return this.entitySingular;var e=this.attrs(t.ItemNameAttribute);if(e.length>=1){this.entitySingular=e[0].value;this.entitySingular=Q.LT.getDefault(this.entitySingular,this.entitySingular)}else{var i=Q.tryGetText(this.getLocalTextDbPrefix()+"EntitySingular");if(i==null)i=this.getEntityType();this.entitySingular=i}return this.entitySingular};i.prototype.getNameProperty=function(){if(this.nameProperty!=null)return this.nameProperty;var e=this.attrs(t.NamePropertyAttribute);if(e.length>=1)this.nameProperty=e[0].value;else this.nameProperty="Name";return this.nameProperty};i.prototype.getIdProperty=function(){if(this.idProperty!=null)return this.idProperty;var e=this.attrs(t.IdPropertyAttribute);if(e.length>=1)this.idProperty=e[0].value;else this.idProperty="ID";return this.idProperty};i.prototype.getIsActiveProperty=function(){if(this.isActiveProperty!=null)return this.isActiveProperty;var e=this.attrs(t.IsActivePropertyAttribute);if(e.length>=1)this.isActiveProperty=e[0].value;else this.isActiveProperty="IsActive";return this.isActiveProperty};i.prototype.getIsDeletedProperty=function(){return null};i.prototype.getService=function(){if(this.service!=null)return this.service;var e=this.attrs(t.ServiceAttribute);if(e.length>=1)this.service=e[0].value;else this.service=Q.replaceAll(this.getEntityType(),".","/");return this.service};i.prototype.load=function(t,e,i){var n=this;var o=function(){if(t==null){n.loadResponse({});e&&e();return}var i=typeof t;if(i==="string"||i==="number"){var o=t;n.loadById(o,function(t){if(e)window.setTimeout(e,0)},null);return}var a=t||new Object;n.loadResponse({Entity:a});e&&e()};if(i==null){o();return}try{o()}catch(a){var r=Q.Exception.wrap(a);i(r)}};i.prototype.loadNewAndOpenDialog=function(t){this.loadResponse({});this.dialogOpen(t)};i.prototype.loadEntityAndOpenDialog=function(t,e){this.loadResponse({Entity:t});this.dialogOpen(e)};i.prototype.loadResponse=function(t){t=t||{};this.onLoadingData(t);var e=t.Entity||new Object;this.beforeLoadEntity(e);this.loadEntity(e);this.set_entity(e);this.afterLoadEntity()};i.prototype.loadEntity=function(t){var e=this.getIdProperty();if(e!=null)this.set_entityId(t[e]);this.set_entity(t);if(this.propertyGrid!=null){this.propertyGrid.set_mode(this.isEditMode()?2:1);this.propertyGrid.load(t)}};i.prototype.beforeLoadEntity=function(t){this.localizationPendingValue=null;this.localizationLastValue=null};i.prototype.afterLoadEntity=function(){this.updateInterface();this.updateTitle()};i.prototype.loadByIdAndOpenDialog=function(t,e){var i=this;this.loadById(t,function(t){return window.setTimeout(function(){return i.dialogOpen(e)},0)},function(){if(!i.element.is(":visible")){i.element.remove()}})};i.prototype.onLoadingData=function(t){};i.prototype.getLoadByIdOptions=function(t,e){return{}};i.prototype.getLoadByIdRequest=function(t){var e={};e.EntityId=t;return e};i.prototype.reloadById=function(){this.loadById(this.get_entityId())};i.prototype.loadById=function(t,e,i){var n=this;var o={service:this.getService()+"/Retrieve",blockUI:true,request:this.getLoadByIdRequest(t),onSuccess:function(t){n.loadResponse(t);e&&e(t)},onCleanup:function(){if(n.validator!=null){Q.validatorAbortHandler(n.validator)}}};var a=this.getLoadByIdOptions(t,e);var r=Q.extend(o,a);this.loadByIdHandler(r,e,i)};i.prototype.loadByIdHandler=function(t,e,i){var n=Q.serviceCall(t);i&&n.fail(i)};i.prototype.initLocalizationGrid=function(){var t=this.byId("PropertyGrid");if(t.length<=0){return}var e=this.getPropertyGridOptions();this.initLocalizationGridCommon(e)};i.prototype.initLocalizationGridCommon=function(e){var i=this.byId("PropertyGrid");if(!Q.any(e.items,function(t){return t.localizable===true}))return;var n=$("<div/>").attr("id",this.idPrefix+"LocalizationGrid").hide().insertAfter(i);e.idPrefix=this.idPrefix+"Localization_";var o=[];for(var a=0,r=e.items;a<r.length;a++){var l=r[a];var s=null;if(l.localizable===true){var u=Q.extend({},l);u.oneWay=true;u.readOnly=true;u.required=false;u.defaultValue=null;o.push(u);if(s==null)s=this.getLangs();for(var d=0,h=s;d<h.length;d++){var c=h[d];u=Q.extend({},l);u.name=c[0]+"$"+u.name;u.title=c[1];u.cssClass=[u.cssClass,"translation"].join(" ");u.insertable=true;u.updatable=true;u.oneWay=false;u.required=false;u.localizable=false;u.defaultValue=null;o.push(u)}}}e.items=o;this.localizationGrid=new t.PropertyGrid(n,e).init(null);n.addClass("s-LocalizationGrid")};i.prototype.isLocalizationMode=function(){return this.localizationButton!=null&&this.localizationButton.hasClass("pressed")};i.prototype.isLocalizationModeAndChanged=function(){if(!this.isLocalizationMode()){return false}var t=this.getLocalizationGridValue();return $.toJSON(this.localizationLastValue)!=$.toJSON(t)};i.prototype.localizationButtonClick=function(){if(this.isLocalizationMode()&&!this.validateForm()){return}if(this.isLocalizationModeAndChanged()){var t=this.getLocalizationGridValue();this.localizationLastValue=t;this.localizationPendingValue=t}this.localizationButton.toggleClass("pressed");this.updateInterface();if(this.isLocalizationMode()){this.loadLocalization()}};i.prototype.getLanguages=function(){if(t.EntityDialog.defaultLanguageList!=null)return t.EntityDialog.defaultLanguageList()||[];return[]};i.prototype.getLangs=function(){var t=this.getLanguages();var e=Q.safeCast(t,Array);if(e==null||e.length===0||e[0]==null||!Q.isArray(e[0])){e=Array.prototype.slice.call(t.map(function(t){return[t.item1,t.item2]}))}return e};i.prototype.loadLocalization=function(){var t=this;if(this.localizationLastValue==null&&this.isNew()){this.localizationGrid.load({});this.setLocalizationGridCurrentValues();this.localizationLastValue=this.getLocalizationGridValue();return}if(this.localizationLastValue!=null){this.localizationGrid.load(this.localizationLastValue);this.setLocalizationGridCurrentValues();return}var e={service:this.getService()+"/Retrieve",blockUI:true,request:{EntityId:this.get_entityId(),ColumnSelection:"keyOnly",IncludeColumns:["Localizations"]},onSuccess:function(e){var i=Q.extend(new Object,t.get_entity());if(e.Localizations){for(var n=0,o=Object.keys(e.Localizations);n<o.length;n++){var a=o[n];var r=e.Localizations[a];for(var l=0,s=Object.keys(r);l<s.length;l++){var u=s[l];i[a+"$"+u]=r[u]}}}t.localizationGrid.load(i);t.setLocalizationGridCurrentValues();t.localizationPendingValue=null;t.localizationLastValue=t.getLocalizationGridValue()}};Q.serviceCall(e)};i.prototype.setLocalizationGridCurrentValues=function(){var t=this;var e={};this.localizationGrid.enumerateItems(function(i,n){if(i.name.indexOf("$")<0&&n.element.is(":input")){e[i.name]=t.byId(i.name).val();n.element.val(e[i.name])}});this.localizationGrid.enumerateItems(function(t,i){var n=t.name.indexOf("$");if(n>=0&&i.element.is(":input")){var o=e[t.name.substr(n+1)];if(o!=null&&o.length>0){i.element.attr("title",o).attr("placeholder",o)}}})};i.prototype.getLocalizationGridValue=function(){var t={};this.localizationGrid.save(t);for(var e=0,i=Object.keys(t);e<i.length;e++){var n=i[e];if(n.indexOf("$")<0){delete t[n]}}return t};i.prototype.getPendingLocalizations=function(){if(this.localizationPendingValue==null){return null}var t={};var e=this.getIdProperty();var i=this.getLangs();for(var n=0,o=i;n<o.length;n++){var a=o[n];var r=a[0];var l={};if(e!=null){l[e]=this.get_entityId()}var s=r+"$";for(var u=0,d=Object.keys(this.localizationPendingValue);u<d.length;u++){var h=d[u];if(Q.startsWith(h,s))l[h.substr(s.length)]=this.localizationPendingValue[h]}t[r]=l}return t};i.prototype.initPropertyGrid=function(){var e=this.byId("PropertyGrid");if(e.length<=0){return}var i=this.getPropertyGridOptions();this.propertyGrid=new t.PropertyGrid(e,i).init(null);if(this.element.closest(".ui-dialog").hasClass("s-Flexify")){this.propertyGrid.element.children(".categories").flexHeightOnly(1)}};i.prototype.getPropertyItems=function(){var t=this.getFormKey();return Q.getForm(t)};i.prototype.getPropertyGridOptions=function(){return{idPrefix:this.idPrefix,items:this.getPropertyItems(),mode:1,localTextPrefix:"Forms."+this.getFormKey()+".",useCategories:true}};i.prototype.validateBeforeSave=function(){return true};i.prototype.getSaveOptions=function(t){var e=this;var i={};i.service=this.getService()+"/"+(this.isEditMode()?"Update":"Create"),i.onSuccess=function(n){e.onSaveSuccess(n);t&&t(n);var o=e.isEditMode()?"update":"create";var a=i.request==null?null:i.request.Entity;var r=e.isEditMode()?e.get_entityId():n==null?null:n.EntityId;var l={type:o,entity:a,entityId:r};e.element.triggerHandler("ondatachange",[l])};i.onCleanup=function(){e.validator&&Q.validatorAbortHandler(e.validator)};i.request=this.getSaveRequest();return i};i.prototype.getSaveEntity=function(){var t=new Object;if(this.propertyGrid!=null){this.propertyGrid.save(t)}if(this.isEditMode()){var e=this.getIdProperty();if(e!=null&&t[e]==null){t[e]=this.get_entityId()}}return t};i.prototype.getSaveRequest=function(){var t=this.getSaveEntity();
var e={};e.Entity=t;if(this.isEditMode()){var i=this.getIdProperty();if(i!=null){e.EntityId=this.get_entityId()}}if(this.localizationPendingValue!=null){e.Localizations=this.getPendingLocalizations()}return e};i.prototype.onSaveSuccess=function(t){};i.prototype.save_submitHandler=function(t){var e=this.getSaveOptions(t);this.saveHandler(e,t)};i.prototype.save=function(e){var i=this;return t.ValidationHelper.submit(this.byId("Form"),function(){return i.validateBeforeSave()},function(){return i.save_submitHandler(e)})};i.prototype.saveHandler=function(t,e){Q.serviceCall(t)};i.prototype.initToolbar=function(){e.prototype.initToolbar.call(this);if(!this.toolbar)return;this.saveAndCloseButton=this.toolbar.findButton("save-and-close-button");this.applyChangesButton=this.toolbar.findButton("apply-changes-button");this.deleteButton=this.toolbar.findButton("delete-button");this.undeleteButton=this.toolbar.findButton("undo-delete-button");this.editButton=this.toolbar.findButton("edit-button");this.cloneButton=this.toolbar.findButton("clone-button");this.localizationButton=this.toolbar.findButton("localization-button")};i.prototype.showSaveSuccessMessage=function(t){Q.notifySuccess(Q.text("Controls.EntityDialog.SaveSuccessMessage"),"",null)};i.prototype.getToolbarButtons=function(){var e=this;var i=[];i.push({title:Q.text("Controls.EntityDialog.SaveButton"),cssClass:"save-and-close-button",hotkey:"alt+s",onClick:function(){e.save(function(t){e.dialogClose()})},visible:function(){return!e.isDeleted()&&!e.isViewMode()},disabled:function(){return!e.hasSavePermission()||e.readOnly}});i.push({title:"",hint:Q.text("Controls.EntityDialog.ApplyChangesButton"),cssClass:"apply-changes-button",hotkey:"alt+a",onClick:function(){e.save(function(t){if(e.isEditMode()){var i=t.EntityId;if(i==null){i=e.get_entityId()}e.loadById(i)}else{e.loadById(t.EntityId)}e.showSaveSuccessMessage(t)})},visible:function(){return!e.isDeleted()&&!e.isViewMode()},disabled:function(){return!e.hasSavePermission()||e.readOnly}});i.push({title:Q.text("Controls.EntityDialog.DeleteButton"),cssClass:"delete-button",hotkey:"alt+x",onClick:function(){Q.confirm(Q.text("Controls.EntityDialog.DeleteConfirmation"),function(){e.doDelete(function(){return e.dialogClose()})})},visible:function(){return e.isEditMode()&&!e.isDeleted()&&!e.isViewMode()},disabled:function(){return!e.hasDeletePermission()||e.readOnly}});i.push({title:Q.text("Controls.EntityDialog.UndeleteButton"),cssClass:"undo-delete-button",onClick:function(){if(e.isDeleted()){Q.confirm(Q.text("Controls.EntityDialog.UndeleteConfirmation"),function(){e.undelete(function(){return e.loadById(e.get_entityId())})})}},visible:function(){return e.isEditMode()&&e.isDeleted()&&!e.isViewMode()},disabled:function(){return!e.hasDeletePermission()||e.readOnly}});if(this.useViewMode()){i.push({title:Q.text("Controls.EntityDialog.EditButton"),cssClass:"edit-button",icon:"fa-edit",onClick:function(){if(!e.isEditMode())return;e.editClicked=true;e.updateInterface();e.updateTitle()},visible:function(){return e.isViewMode()},disabled:function(){return!e.hasSavePermission()||e.readOnly}})}i.push({title:Q.text("Controls.EntityDialog.LocalizationButton"),cssClass:"localization-button",onClick:function(){return e.localizationButtonClick()}});i.push({title:Q.text("Controls.EntityDialog.CloneButton"),cssClass:"clone-button",onClick:function(){if(!e.isEditMode()){return}var i=e.getCloningEntity();t.Widget.create({type:Q.getInstanceType(e),init:function(n){return t.SubDialogHelper.bubbleDataChange(t.SubDialogHelper.cascade(n,e.element),e,true).loadEntityAndOpenDialog(i,null)}})},visible:function(){return false},disabled:function(){return!e.hasInsertPermission()||e.readOnly}});return i};i.prototype.getCloningEntity=function(){var t=new Object;t=Q.extend(t,this.get_entity());var e=this.getIdProperty();if(!Q.isEmptyOrNull(e)){delete t[e]}var i=this.getIsActiveProperty();if(!Q.isEmptyOrNull(i)){delete t[i]}var n=this.getIsDeletedProperty();if(!Q.isEmptyOrNull(n)){delete t[n]}return t};i.prototype.updateInterface=function(){t.EditorUtils.setContainerReadOnly(this.byId("Form"),false);var e=this.isDeleted();var i=this.isLocalizationMode();var n=this.hasSavePermission();var o=this.isViewMode();var e=this.isDeleted();var a=this.readOnly;this.toolbar.updateInterface();if(this.tabs!=null){t.TabsExtensions.setDisabled(this.tabs,"Log",this.isNewOrDeleted())}if(this.propertyGrid!=null){this.propertyGrid.element.toggle(!i)}if(this.localizationGrid!=null){this.localizationGrid.element.toggle(i)}if(this.localizationButton!=null){this.localizationButton.toggle(this.localizationGrid!=null);this.localizationButton.find(".button-inner").text(this.isLocalizationMode()?Q.text("Controls.EntityDialog.LocalizationBack"):Q.text("Controls.EntityDialog.LocalizationButton"))}if(i){if(this.toolbar!=null)this.toolbar.findButton("tool-button").not(".localization-hidden").addClass(".localization-hidden").hide();this.localizationButton&&this.localizationButton.show();return}this.toolbar.findButton("localization-hidden").removeClass("localization-hidden").show();this.saveAndCloseButton&&this.saveAndCloseButton.find(".button-inner").text(Q.text(this.isNew()?"Controls.EntityDialog.SaveButton":"Controls.EntityDialog.UpdateButton"));if(!n||o||a)t.EditorUtils.setContainerReadOnly(this.byId("Form"),true)};i.prototype.getUndeleteOptions=function(t){return{}};i.prototype.undeleteHandler=function(t,e){Q.serviceCall(t)};i.prototype.undelete=function(t){var e=this;var i={};i.service=this.getService()+"/Undelete";var n={};n.EntityId=this.get_entityId();i.request=n;i.onSuccess=function(i){t&&t(i);e.element.triggerHandler("ondatachange",[{entityId:e.get_entityId(),entity:e.entity,type:"undelete"}])};var o=this.getUndeleteOptions(t);var a=Q.extend(i,o);this.undeleteHandler(a,t)};Object.defineProperty(i.prototype,"readOnly",{get:function(){return this.get_readOnly()},set:function(t){this.set_readOnly(t)},enumerable:true,configurable:true});i.prototype.get_readOnly=function(){return!!this._readonly};i.prototype.set_readOnly=function(t){if(!!this._readonly!=!!t){this._readonly=!!t;this.updateInterface();this.updateTitle()}};i.prototype.getInsertPermission=function(){return null};i.prototype.getUpdatePermission=function(){return null};i.prototype.getDeletePermission=function(){return null};i.prototype.hasDeletePermission=function(){var t=this.getDeletePermission();return t==null||Q.Authorization.hasPermission(t)};i.prototype.hasInsertPermission=function(){var t=this.getInsertPermission();return t==null||Q.Authorization.hasPermission(t)};i.prototype.hasUpdatePermission=function(){var t=this.getUpdatePermission();return t==null||Q.Authorization.hasPermission(t)};i.prototype.hasSavePermission=function(){return this.isNew()?this.hasInsertPermission():this.hasUpdatePermission()};i.prototype.isViewMode=function(){return this.useViewMode()&&this.isEditMode()&&!this.editClicked};i.prototype.useViewMode=function(){return false};i=__decorate([t.Decorators.registerClass("Serenity.EntityDialog",[t["IEditDialog"],t.IReadOnly])],i);return i}(t.TemplatedDialog);t.EntityDialog=e})(Serenity||(Serenity={}));