var Serenity;(function(t){var e;(function(t){t.isTrue="true";t.isFalse="false";t.contains="contains";t.startsWith="startswith";t.EQ="eq";t.NE="ne";t.GT="gt";t.GE="ge";t.LT="lt";t.LE="le";t.BW="bw";t.IN="in";t.isNull="isnull";t.isNotNull="isnotnull";t.toCriteriaOperator={eq:"=",ne:"!=",gt:">",ge:">=",lt:"<",le:"<="}})(e=t.FilterOperators||(t.FilterOperators={}))})(Serenity||(Serenity={}));var Serenity;(function(t){var e=function(){function e(t){this.items=[];if(t==null){throw new Q.ArgumentNullException("source")}this.fields=t.slice();this.get_fields().sort(function(t,e){var r=Q.tryGetText(t.title);if(r==null){r=t.title;if(r==null)r=t.name}var i=Q.tryGetText(e.title);if(i==null){i=e.title;if(i==null)i=e.name}return Q.Culture.stringCompare(r,i)});this.fieldByName={};for(var e=0,r=t;e<r.length;e++){var i=r[e];this.get_fieldByName()[i.name]=i}}r=e;e.getCriteriaFor=function(e){if(e==null)return[""];var r=false;var i=[""];var n=false;var o=[""];for(var a=0;a<e.length;a++){var s=e[a];if(s.leftParen||r&&s.rightParen){if(!t.Criteria.isEmpty(i)){if(r)i=t.Criteria.paren(i);if(n)o=t.Criteria.join(o,"or",i);else o=t.Criteria.join(o,"and",i);i=[""]}r=false}if(s.leftParen){n=s.isOr;r=true}if(s.isOr)i=t.Criteria.join(i,"or",s.criteria);else i=t.Criteria.join(i,"and",s.criteria)}if(!t.Criteria.isEmpty(i)){if(n)o=t.Criteria.join(o,"or",t.Criteria.paren(i));else o=t.Criteria.join(o,"and",t.Criteria.paren(i))}return o};e.getDisplayTextFor=function(t){if(t==null)return"";var e=false;var r="";for(var i=0;i<t.length;i++){var n=t[i];if(e&&(n.rightParen||n.leftParen)){r+=")";e=false}if(r.length>0){r+=" "+Q.text("Controls.FilterPanel."+(n.isOr?"Or":"And"))+" "}if(n.leftParen){r+="(";e=true}r+=n.displayText}if(e){r+=")"}return r};e.prototype.get_fields=function(){return this.fields};e.prototype.get_fieldByName=function(){return this.fieldByName};e.prototype.get_items=function(){return this.items};e.prototype.raiseChanged=function(){this.displayText=null;this.changed&&this.changed(this,{})};e.prototype.add_changed=function(t){this.changed=Q.delegateCombine(this.changed,t)};e.prototype.remove_changed=function(t){this.changed=Q.delegateRemove(this.changed,t)};e.prototype.get_activeCriteria=function(){return r.getCriteriaFor(this.items)};e.prototype.get_displayText=function(){if(this.displayText==null)this.displayText=r.getDisplayTextFor(this.items);return this.displayText};var r;e=r=__decorate([t.Decorators.registerClass("FilterStore")],e);return e}();t.FilterStore=e})(Serenity||(Serenity={}));var Serenity;(function(t){var e=function(){function e(){}e=__decorate([t.Decorators.registerInterface("Serenity.IFiltering")],e);return e}();t.IFiltering=e;var r=function(){function e(){}e=__decorate([t.Decorators.registerInterface("Serenity.IQuickFiltering")],e);return e}();t.IQuickFiltering=r;var i=t.FilterOperators;var n=t.Decorators.option;var o=function(){function i(){}i.prototype.get_field=function(){return this.field};i.prototype.set_field=function(t){this.field=t};i.prototype.get_container=function(){return this.container};i.prototype.set_container=function(t){this.container=t};i.prototype.get_operator=function(){return this.operator};i.prototype.set_operator=function(t){this.operator=t};i.prototype.appendNullableOperators=function(e){if(!this.isNullable()){return e}e.push({key:t.FilterOperators.isNotNull});e.push({key:t.FilterOperators.isNull});return e};i.prototype.appendComparisonOperators=function(e){e.push({key:t.FilterOperators.EQ});e.push({key:t.FilterOperators.NE});e.push({key:t.FilterOperators.LT});e.push({key:t.FilterOperators.LE});e.push({key:t.FilterOperators.GT});e.push({key:t.FilterOperators.GE});return e};i.prototype.isNullable=function(){return this.get_field().required!==true};i.prototype.createEditor=function(){switch(this.get_operator().key){case"true":case"false":case"isnull":case"isnotnull":{return}case"contains":case"startswith":case"eq":case"ne":case"lt":case"le":case"gt":case"ge":{this.get_container().html('<input type="text"/>');return}}throw new Q.Exception(Q.format("Filtering '{0}' has no editor for '{1}' operator",Q.getTypeName(Q.getInstanceType(this)),this.get_operator().key))};i.prototype.operatorFormat=function(t){return Q.coalesce(t.format,Q.coalesce(Q.tryGetText("Controls.FilterPanel.OperatorFormats."+t.key),t.key))};i.prototype.getTitle=function(t){return Q.coalesce(Q.tryGetText(t.title),Q.coalesce(t.title,t.name))};i.prototype.displayText=function(t,e){if(!e||e.length===0){return Q.format(this.operatorFormat(t),this.getTitle(this.field))}else if(e.length===1){return Q.format(this.operatorFormat(t),this.getTitle(this.field),e[0])}else{return Q.format(this.operatorFormat(t),this.getTitle(this.field),e[0],e[1])}};i.prototype.getCriteriaField=function(){return this.field.name};i.prototype.getCriteria=function(){var e={};var r;switch(this.get_operator().key){case"true":{e.displayText=this.displayText(this.get_operator(),[]);e.criteria=[[this.getCriteriaField()],"=",true];return e}case"false":{e.displayText=this.displayText(this.get_operator(),[]);e.criteria=[[this.getCriteriaField()],"=",false];return e}case"isnull":{e.displayText=this.displayText(this.get_operator(),[]);e.criteria=["is null",[this.getCriteriaField()]];return e}case"isnotnull":{e.displayText=this.displayText(this.get_operator(),[]);e.criteria=["is not null",[this.getCriteriaField()]];return e}case"contains":{r=this.getEditorText();e.displayText=this.displayText(this.get_operator(),[r]);e.criteria=[[this.getCriteriaField()],"like","%"+r+"%"];return e}case"startswith":{r=this.getEditorText();e.displayText=this.displayText(this.get_operator(),[r]);e.criteria=[[this.getCriteriaField()],"like",r+"%"];return e}case"eq":case"ne":case"lt":case"le":case"gt":case"ge":{r=this.getEditorText();e.displayText=this.displayText(this.get_operator(),[r]);e.criteria=[[this.getCriteriaField()],t.FilterOperators.toCriteriaOperator[this.get_operator().key],this.getEditorValue()];return e}}throw new Q.Exception(Q.format("Filtering '{0}' has no handler for '{1}' operator",Q.getTypeName(Q.getInstanceType(this)),this.get_operator().key))};i.prototype.loadState=function(t){var e=this.get_container().find(":input").first();e.val(t)};i.prototype.saveState=function(){switch(this.get_operator().key){case"contains":case"startswith":case"eq":case"ne":case"lt":case"le":case"gt":case"ge":{var t=this.get_container().find(":input").first();return t.val()}}return null};i.prototype.argumentNull=function(){return new Q.ArgumentNullException("value",Q.text("Controls.FilterPanel.ValueRequired"))};i.prototype.validateEditorValue=function(t){if(t.length===0){throw this.argumentNull()}return t};i.prototype.getEditorValue=function(){var t=this.get_container().find(":input").not(".select2-focusser").first();if(t.length!==1){throw new Q.Exception(Q.format("Couldn't find input in filter container for {0}",Q.coalesce(this.field.title,this.field.name)))}var e;if(t.data("select2")!=null){e=t.select2("val")}else{e=t.val()}e=Q.coalesce(e,"").trim();return this.validateEditorValue(e)};i.prototype.getEditorText=function(){var t=this.get_container().find(":input").not(".select2-focusser").not(".select2-input").first();if(t.length===0){return this.get_container().text().trim()}var e;if(t.data("select2")!=null){e=Q.coalesce(t.select2("data"),{}).text}else{e=t.val()}return e};i.prototype.initQuickFilter=function(e){e.field=this.getCriteriaField();e.type=t.StringEditor;e.title=this.getTitle(this.field);e.options=Q.deepClone(this.get_field().quickFilterParams)};i=__decorate([t.Decorators.registerClass("Serenity.BaseFiltering",[e,r])],i);return i}();t.BaseFiltering=o;function a(e){return t.Decorators.registerClass("Serenity."+e+"Filtering")}var s=function(e){__extends(r,e);function r(t){var r=e.call(this)||this;r.editorType=t;return r}r.prototype.useEditor=function(){switch(this.get_operator().key){case"eq":case"ne":case"lt":case"le":case"gt":case"ge":return true}return false};r.prototype.createEditor=function(){if(this.useEditor()){this.editor=t.Widget.create({type:this.editorType,container:this.get_container(),options:this.getEditorOptions(),init:null});return}this.editor=null;e.prototype.createEditor.call(this)};r.prototype.useIdField=function(){return false};r.prototype.getCriteriaField=function(){if(this.useEditor()&&this.useIdField()&&!Q.isEmptyOrNull(this.get_field().filteringIdField)){return this.get_field().filteringIdField}return e.prototype.getCriteriaField.call(this)};r.prototype.getEditorOptions=function(){var t=Q.deepClone(this.get_field().editorParams||{});delete t["cascadeFrom"];return Q.extend(t,this.get_field().filteringParams)};r.prototype.loadState=function(r){if(this.useEditor()){if(r==null){return}t.EditorUtils.setValue(this.editor,r);return}e.prototype.loadState.call(this,r)};r.prototype.saveState=function(){if(this.useEditor()){return t.EditorUtils.getValue(this.editor)}return e.prototype.saveState.call(this)};r.prototype.getEditorValue=function(){if(this.useEditor()){var r=t.EditorUtils.getValue(this.editor);if(r==null||typeof r=="string"&&r.trim().length===0)throw this.argumentNull();return r}return e.prototype.getEditorValue.call(this)};r.prototype.initQuickFilter=function(t){e.prototype.initQuickFilter.call(this,t);t.type=this.editorType;t.options=Q.extend(Q.extend({},Q.deepClone(this.getEditorOptions())),Q.deepClone(this.get_field().quickFilterParams))};r=__decorate([a("BaseEditor")],r);return r}(o);t.BaseEditorFiltering=s;var l=function(e){__extends(r,e);function r(){return e.call(this,t.DateEditor)||this}r.prototype.getOperators=function(){return this.appendNullableOperators(this.appendComparisonOperators([]))};r=__decorate([a("Date")],r);return r}(s);t.DateFiltering=l;var u=function(e){__extends(r,e);function r(){return e!==null&&e.apply(this,arguments)||this}r.prototype.getOperators=function(){return this.appendNullableOperators([{key:t.FilterOperators.isTrue},{key:t.FilterOperators.isFalse}])};r=__decorate([a("Boolean")],r);return r}(o);t.BooleanFiltering=u;var c=function(e){__extends(r,e);function r(){return e.call(this,t.DateTimeEditor)||this}r.prototype.getOperators=function(){return this.appendNullableOperators(this.appendComparisonOperators([]))};r.prototype.getCriteria=function(){var r={};switch(this.get_operator().key){case"eq":case"ne":case"lt":case"le":case"gt":case"ge":{{var i=this.getEditorText();r.displayText=this.displayText(this.get_operator(),[i]);var n=Q.parseISODateTime(this.getEditorValue());n=new Date(n.getFullYear(),n.getMonth(),n.getDate());var o=new Date(n.getFullYear(),n.getMonth(),n.getDate()+1);var a=[this.getCriteriaField()];var s=Q.formatDate(n,"yyyy-MM-dd");var l=Q.formatDate(o,"yyyy-MM-dd");switch(this.get_operator().key){case"eq":{r.criteria=t.Criteria.join([a,">=",s],"and",[a,"<",l]);return r}case"ne":{r.criteria=t.Criteria.paren(t.Criteria.join([a,"<",s],"or",[a,">",l]));return r}case"lt":{r.criteria=[a,"<",s];return r}case"le":{r.criteria=[a,"<",l];return r}case"gt":{r.criteria=[a,">=",l];return r}case"ge":{r.criteria=[a,">=",s];return r}}}break}}return e.prototype.getCriteria.call(this)};r=__decorate([a("DateTime")],r);return r}(s);t.DateTimeFiltering=c;var p=function(e){__extends(r,e);function r(){return e.call(this,t.DecimalEditor)||this}r.prototype.getOperators=function(){return this.appendNullableOperators(this.appendComparisonOperators([]))};r=__decorate([a("Decimal")],r);return r}(s);t.DecimalFiltering=p;var d=function(e){__extends(r,e);function r(){return e.call(this,t.Widget)||this}r.prototype.getOperators=function(){var t=[];t.push({key:i.EQ});t.push({key:i.NE});if(this.useRelative){t.push({key:i.LT});t.push({key:i.LE});t.push({key:i.GT});t.push({key:i.GE})}if(this.useLike){t.push({key:i.contains});t.push({key:i.startsWith})}this.appendNullableOperators(t);return t};r.prototype.useEditor=function(){var t=this.get_operator().key;return t===i.EQ||t===i.NE||this.useRelative&&(t===i.LT||t===i.LE||t===i.GT||t===i.GE)};r.prototype.getEditorOptions=function(){var t=e.prototype.getEditorOptions.call(this);if(this.useEditor()&&this.editorType===Q.coalesce(this.get_field().editorType,"String")){t=Q.extend(t,this.get_field().editorParams)}return t};r.prototype.createEditor=function(){var r=this;if(this.useEditor()){var i=t.EditorTypeRegistry.get(this.editorType);this.editor=t.Widget.create({type:i,element:function(t){return t.appendTo(r.get_container())},options:this.getEditorOptions()});return}e.prototype.createEditor.call(this)};r.prototype.useIdField=function(){return this.useEditor()};r.prototype.initQuickFilter=function(r){e.prototype.initQuickFilter.call(this,r);r.type=t.EditorTypeRegistry.get(this.editorType)};__decorate([n()],r.prototype,"editorType",void 0);__decorate([n()],r.prototype,"useRelative",void 0);__decorate([n()],r.prototype,"useLike",void 0);r=__decorate([a("Editor")],r);return r}(s);t.EditorFiltering=d;var h=function(e){__extends(r,e);function r(){return e.call(this,t.EnumEditor)||this}r.prototype.getOperators=function(){var t=[{key:i.EQ},{key:i.NE}];return this.appendNullableOperators(t)};r=__decorate([a("Enum")],r);return r}(s);t.EnumFiltering=h;var f=function(e){__extends(r,e);function r(){return e.call(this,t.IntegerEditor)||this}r.prototype.getOperators=function(){return this.appendNullableOperators(this.appendComparisonOperators([]))};r=__decorate([a("Integer")],r);return r}(s);t.IntegerFiltering=f;var g=function(e){__extends(r,e);function r(){return e.call(this,t.LookupEditor)||this}r.prototype.getOperators=function(){var t=[{key:i.EQ},{key:i.NE},{key:i.contains},{key:i.startsWith}];return this.appendNullableOperators(t)};r.prototype.useEditor=function(){var t=this.get_operator().key;return t==i.EQ||t==i.NE};r.prototype.useIdField=function(){return this.useEditor()};r.prototype.getEditorText=function(){if(this.useEditor()){return this.editor.text}return e.prototype.getEditorText.call(this)};r=__decorate([a("Lookup")],r);return r}(s);t.LookupFiltering=g;var y=function(e){__extends(r,e);function r(){return e.call(this,t.ServiceLookupEditor)||this}r.prototype.getOperators=function(){var t=[{key:i.EQ},{key:i.NE},{key:i.contains},{key:i.startsWith}];return this.appendNullableOperators(t)};r.prototype.useEditor=function(){var t=this.get_operator().key;return t==i.EQ||t==i.NE};r.prototype.useIdField=function(){return this.useEditor()};r.prototype.getEditorText=function(){if(this.useEditor()){return this.editor.text}return e.prototype.getEditorText.call(this)};r=__decorate([a("ServiceLookup")],r);return r}(s);t.ServiceLookupFiltering=y;var v=function(t){__extends(e,t);function e(){return t!==null&&t.apply(this,arguments)||this}e.prototype.getOperators=function(){var t=[{key:i.contains},{key:i.startsWith},{key:i.EQ},{key:i.NE}];return this.appendNullableOperators(t)};e.prototype.validateEditorValue=function(e){if(e.length===0){return e}return t.prototype.validateEditorValue.call(this,e)};e=__decorate([a("String")],e);return e}(o);t.StringFiltering=v;var _;(function(e){var r;function i(){if(r!=null)return;r={};for(var e=0,i=Q.getTypes();e<i.length;e++){var o=i[e];if(!Q.isAssignableFrom(t.IFiltering,o))continue;var a=Q.getTypeFullName(o).toLowerCase();r[a]=o;for(var s=0,l=Q.Config.rootNamespaces;s<l.length;s++){var u=l[s];if(Q.startsWith(a,u.toLowerCase()+".")){var c=a.substr(u.length+1).toLowerCase();if(r[c]==null){r[c]=o}}}}n()}function n(){var t="filtering";for(var e=0,i=Object.keys(r);e<i.length;e++){var n=i[e];if(!Q.endsWith(n,t))continue;var o=n.substr(0,n.length-t.length);if(Q.isEmptyOrNull(o))continue;if(r[o]!=null)continue;r[o]=r[n]}}function o(){r=null}function a(t){if(Q.isEmptyOrNull(t))throw new Q.ArgumentNullException("key");i();var e=r[t.toLowerCase()];if(e==null)throw new Q.Exception(Q.format("Can't find {0} filter handler type!",t));return e}e.get=a})(_=t.FilteringTypeRegistry||(t.FilteringTypeRegistry={}))})(Serenity||(Serenity={}));var Serenity;(function(t){var e=function(e){__extends(r,e);function r(r,i){var n=e.call(this,r,i)||this;n.store=new t.FilterStore([]);n.onFilterStoreChanged=function(){return n.filterStoreChanged()};n.store.add_changed(n.onFilterStoreChanged);return n}r.prototype.destroy=function(){if(this.store){this.store.remove_changed(this.onFilterStoreChanged);this.onFilterStoreChanged=null;this.store=null}e.prototype.destroy.call(this)};r.prototype.filterStoreChanged=function(){};r.prototype.get_store=function(){return this.store};r.prototype.set_store=function(e){if(this.store!==e){if(this.store!=null)this.store.remove_changed(this.onFilterStoreChanged);this.store=e||new t.FilterStore([]);this.store.add_changed(this.onFilterStoreChanged);this.filterStoreChanged()}};r=__decorate([t.Decorators.registerClass("Serenity.FilterWidgetBase")],r);return r}(t.TemplatedWidget);t.FilterWidgetBase=e})(Serenity||(Serenity={}));var Serenity;(function(t){var e=function(e){__extends(r,e);function r(t,r){var i=e.call(this,t)||this;for(var n=0,o=r;n<o.length;n++){var a=o[n];i.addOption(a.name,Q.coalesce(Q.tryGetText(a.title),Q.coalesce(a.title,a.name)),a)}return i}r.prototype.emptyItemText=function(){if(Q.isEmptyOrNull(this.value)){return Q.text("Controls.FilterPanel.SelectField")}return null};r.prototype.getSelect2Options=function(){var t=e.prototype.getSelect2Options.call(this);t.allowClear=false;return t};r=__decorate([t.Decorators.registerClass("Serenity.FilterFieldSelect")],r);return r}(t.Select2Editor);var r=function(e){__extends(r,e);function r(t,r){var i=e.call(this,t)||this;for(var n=0,o=r;n<o.length;n++){var a=o[n];var s=Q.coalesce(a.title,Q.coalesce(Q.tryGetText("Controls.FilterPanel.OperatorNames."+a.key),a.key));i.addOption(a.key,s,a)}if(r.length&&r[0])i.value=r[0].key;return i}r.prototype.emptyItemText=function(){return null};r.prototype.getSelect2Options=function(){var t=e.prototype.getSelect2Options.call(this);t.allowClear=false;return t};r=__decorate([t.Decorators.registerClass("Serenity.FilterOperatorSelect")],r);return r}(t.Select2Editor);var i=function(i){__extends(n,i);function n(t){var e=i.call(this,t)||this;e.element.addClass("s-FilterPanel");e.rowsDiv=e.byId("Rows");e.initButtons();e.updateButtons();return e}n.prototype.get_showInitialLine=function(){return this.showInitialLine};n.prototype.set_showInitialLine=function(t){if(this.showInitialLine!==t){this.showInitialLine=t;if(this.showInitialLine&&this.rowsDiv.children().length===0){this.addEmptyRow(false)}}};n.prototype.filterStoreChanged=function(){i.prototype.filterStoreChanged.call(this);this.updateRowsFromStore()};n.prototype.updateRowsFromStore=function(){this.rowsDiv.empty();var t=this.get_store().get_items();for(var i=0,n=t;i<n.length;i++){var o=n[i];this.addEmptyRow(false);var a=this.rowsDiv.children().last();var s=a.children("div.l");s.children(".leftparen").toggleClass("active",!!o.leftParen);s.children(".rightparen").toggleClass("active",!!o.rightParen);s.children(".andor").toggleClass("or",!!o.isOr).text(Q.text(!!o.isOr?"Controls.FilterPanel.Or":"Controls.FilterPanel.And"));var l=a.children("div.f").find("input.field-select").getWidget(e);l.value=o.field;this.rowFieldChange(a);var u=a.children("div.o").find("input.op-select").getWidget(r);u.set_value(o.operator);this.rowOperatorChange(a);var c=this.getFilteringFor(a);if(c!=null){c.set_operator({key:o.operator});c.loadState(o.state)}}if(this.get_showInitialLine()&&this.rowsDiv.children().length===0){this.addEmptyRow(false)}this.updateParens()};n.prototype.get_showSearchButton=function(){return this.showSearchButton};n.prototype.set_showSearchButton=function(t){if(this.showSearchButton!==t){this.showSearchButton=t;this.updateButtons()}};n.prototype.get_updateStoreOnReset=function(){return this.updateStoreOnReset};n.prototype.set_updateStoreOnReset=function(t){if(this.updateStoreOnReset!==t){this.updateStoreOnReset=t}};n.prototype.getTemplate=function(){return"<div id='~_Rows' class='filter-lines'>"+"</div>"+"<div id='~_Buttons' class='buttons'>"+"<button id='~_AddButton' class='btn btn-primary add'></button>"+"<button id='~_SearchButton' class='btn btn-success search'></button>"+"<button id='~_ResetButton' class='btn btn-danger reset'></button>"+"</div>"+"<div style='clear: both'>"+"</div>"};n.prototype.initButtons=function(){var t=this;this.byId("AddButton").text(Q.text("Controls.FilterPanel.AddFilter")).click(function(e){return t.addButtonClick(e)});this.byId("SearchButton").text(Q.text("Controls.FilterPanel.SearchButton")).click(function(e){return t.searchButtonClick(e)});this.byId("ResetButton").text(Q.text("Controls.FilterPanel.ResetButton")).click(function(e){return t.resetButtonClick(e)})};n.prototype.searchButtonClick=function(t){t.preventDefault();this.search()};n.prototype.get_hasErrors=function(){return this.rowsDiv.children().children("div.v").children("span.error").length>0};n.prototype.search=function(){this.rowsDiv.children().children("div.v").children("span.error").remove();var t=[];var e=null;var i=null;for(var n=0;n<this.rowsDiv.children().length;n++){i=this.rowsDiv.children().eq(n);var o=this.getFilteringFor(i);if(o==null){continue}var a=this.getFieldFor(i);var s=i.children("div.o").find("input.op-select").getWidget(r).value;if(s==null||s.length===0){e=Q.text("Controls.FilterPanel.InvalidOperator");break}var l={};l.field=a.name;l.operator=s;l.isOr=i.children("div.l").children("a.andor").hasClass("or");l.leftParen=i.children("div.l").children("a.leftparen").hasClass("active");l.rightParen=i.children("div.l").children("a.rightparen").hasClass("active");o.set_operator({key:s});var u=o.getCriteria();l.criteria=u.criteria;l.state=o.saveState();l.displayText=u.displayText;t.push(l)}if(e!=null){$("<span/>").addClass("error").attr("title",e).appendTo(i.children("div.v"));i.children("div.v").find("input:first").focus();return}var c=this.get_store().get_items();c.length=0;c.push.apply(c,t);this.get_store().raiseChanged()};n.prototype.addButtonClick=function(t){this.addEmptyRow(true);t.preventDefault()};n.prototype.resetButtonClick=function(t){t.preventDefault();if(this.get_updateStoreOnReset()){if(this.get_store().get_items().length>0){this.get_store().get_items().length=0;this.get_store().raiseChanged()}}this.rowsDiv.empty();this.updateButtons();if(this.get_showInitialLine()){this.addEmptyRow(false)}};n.prototype.findEmptyRow=function(){var t=null;this.rowsDiv.children().each(function(e,r){var i=$(r).children("div.f").children("input.field-select").first();if(i.length===0){return true}var n=i.val();if(n==null||n.length===0){t=$(r);return false}return true});return t};n.prototype.addEmptyRow=function(t){var r=this;var i=this.findEmptyRow();if(i!=null){i.find("input.field-select").select2("focus");if(t){i.find("input.field-select").select2("open")}return i}var n=this.rowsDiv.children().last().children("a.andor").hasClass("or");var o=$("<div class='filter-line'>"+"<a class='delete'><span></span></a>"+"<div class='l'>"+"<a class='rightparen' href='#'>)</a>"+"<a class='andor' href='#'></a>"+"<a class='leftparen' href='#'>(</a>"+"</div>"+"<div class='f'>"+"<input type='hidden' class='field-select'>"+"</div>"+"<div class='o'></div>"+"<div class='v'></div>"+"<div style='clear: both'></div>"+"</div>").appendTo(this.rowsDiv);var a=o.children("div.l").hide();a.children("a.leftparen, a.rightparen").click(function(t){return r.leftRightParenClick(t)});var s=a.children("a.andor").attr("title",Q.text("Controls.FilterPanel.ChangeAndOr"));if(n){s.addClass("or").text(Q.text("Controls.FilterPanel.Or"))}else{s.text(Q.text("Controls.FilterPanel.And"))}s.click(function(t){return r.andOrClick(t)});o.children("a.delete").attr("title",Q.text("Controls.FilterPanel.RemoveField")).click(function(t){return r.deleteRowClick(t)});var l=new e(o.children("div.f").children("input"),this.get_store().get_fields()).changeSelect2(function(t){return r.onRowFieldChange(t)});this.updateParens();this.updateButtons();o.find("input.field-select").select2("focus");if(t){o.find("input.field-select").select2("open")}return o};n.prototype.onRowFieldChange=function(t){var e=$(t.target).closest("div.filter-line");this.rowFieldChange(e);var r=e.children("div.o").find("input.op-select");r.select2("focus")};n.prototype.rowFieldChange=function(t){t.removeData("Filtering");var r=t.children("div.f").find("input.field-select").getWidget(e);var i=r.get_value();var n=i==null||i==="";this.removeFiltering(t);this.populateOperatorList(t);this.rowOperatorChange(t);this.updateParens();this.updateButtons()};n.prototype.removeFiltering=function(t){t.data("Filtering",null);t.data("FilteringField",null)};n.prototype.populateOperatorList=function(t){var e=this;t.children("div.o").html("");var i=this.getFilteringFor(t);if(i==null)return;var n=t.children("div.o").html("<input/>").children().attr("type","hidden").addClass("op-select");var o=i.getOperators();var a=new r(n,o);a.changeSelect2(function(t){return e.onRowOperatorChange(t)})};n.prototype.getFieldFor=function(t){if(t.length===0){return null}var r=t.children("div.f").find("input.field-select").getWidget(e);if(Q.isEmptyOrNull(r.value)){return null}return this.get_store().get_fieldByName()[r.get_value()]};n.prototype.getFilteringFor=function(e){var r=this.getFieldFor(e);if(r==null)return null;var i=Q.cast(e.data("Filtering"),t.IFiltering);if(i!=null)return i;var n=t.FilteringTypeRegistry.get(Q.coalesce(r.filteringType,"String"));var o=e.children("div.v");i=new n;t.ReflectionOptionsSetter.set(i,r.filteringParams);i.set_container(o);i.set_field(r);e.data("Filtering",i);return i};n.prototype.onRowOperatorChange=function(t){var e=$(t.target).closest("div.filter-line");this.rowOperatorChange(e);var r=e.children("div.v").find(":input:visible").first();try{r.focus()}catch(i){}};n.prototype.rowOperatorChange=function(t){if(t.length===0){return}var e=t.children("div.v");e.html("");var i=this.getFilteringFor(t);if(i==null)return;var n=t.children("div.o").find("input.op-select").getWidget(r);if(Q.isEmptyOrNull(n.get_value()))return;var o=i.getOperators().filter(function(t){return t.key===n.value});var a=o.length>0?o[0]:null;if(a==null)return;i.set_operator(a);i.createEditor()};n.prototype.deleteRowClick=function(t){t.preventDefault();var e=$(t.target).closest("div.filter-line");e.remove();if(this.rowsDiv.children().length===0){this.search()}this.updateParens();this.updateButtons()};n.prototype.updateButtons=function(){this.byId("SearchButton").toggle(this.rowsDiv.children().length>=1&&this.showSearchButton);this.byId("ResetButton").toggle(this.rowsDiv.children().length>=1)};n.prototype.andOrClick=function(t){t.preventDefault();var e=$(t.target).toggleClass("or");e.text(Q.text("Controls.FilterPanel."+(e.hasClass("or")?"Or":"And")))};n.prototype.leftRightParenClick=function(t){t.preventDefault();$(t.target).toggleClass("active");this.updateParens()};n.prototype.updateParens=function(){var t=this.rowsDiv.children();if(t.length===0){return}t.removeClass("paren-start");t.removeClass("paren-end");t.children("div.l").css("display",t.length===1?"none":"block");t.first().children("div.l").children("a.rightparen, a.andor").css("visibility","hidden");for(var e=1;e<t.length;e++){var r=t.eq(e);r.children("div.l").css("display","block").children("a.lefparen, a.andor").css("visibility","visible")}var i=false;for(var n=0;n<t.length;n++){var o=t.eq(n);var a=o.children("div.l");var s=a.children("a.leftparen");var l=a.children("a.rightparen");if(l.hasClass("active")&&i){i=false;if(n>0){t.eq(n-1).addClass("paren-end")}}if(s.hasClass("active")){i=true;if(n>0){o.addClass("paren-start")}}}};return n}(t.FilterWidgetBase);t.FilterPanel=i})(Serenity||(Serenity={}));var Serenity;(function(t){var e=function(e){__extends(r,e);function r(){var r=e.call(this)||this;r.filterPanel=new t.FilterPanel(r.byId("FilterPanel"));r.filterPanel.set_showInitialLine(true);r.filterPanel.set_showSearchButton(false);r.filterPanel.set_updateStoreOnReset(false);r.dialogTitle=Q.text("Controls.FilterPanel.DialogTitle");return r}r.prototype.get_filterPanel=function(){return this.filterPanel};r.prototype.getTemplate=function(){return'<div id="~_FilterPanel"/>'};r.prototype.getDialogButtons=function(){var t=this;return[{text:Q.text("Dialogs.OkButton"),click:function(){t.filterPanel.search();if(t.filterPanel.get_hasErrors()){Q.notifyError(Q.text("Controls.FilterPanel.FixErrorsMessage"),"",null);return}t.dialogClose()}},{text:Q.text("Dialogs.CancelButton"),click:function(){return t.dialogClose()}}]};r=__decorate([t.Decorators.registerClass("Serenity.FilterDialog")],r);return r}(t.TemplatedDialog);t.FilterDialog=e})(Serenity||(Serenity={}));var Serenity;(function(t){var e=function(e){__extends(r,e);function r(r){var i=e.call(this,r)||this;i.element.find(".cap").text(Q.text("Controls.FilterPanel.EffectiveFilter"));i.element.find(".edit").text(Q.text("Controls.FilterPanel.EditFilter"));i.element.find(".reset").attr("title",Q.text("Controls.FilterPanel.ResetFilterHint"));var n=function(e){e.preventDefault();var r=new t.FilterDialog;r.get_filterPanel().set_store(i.get_store());r.dialogOpen(null)};i.element.find(".edit").click(n);i.element.find(".txt").click(n);i.element.find(".reset").click(function(t){t.preventDefault();i.get_store().get_items().length=0;i.get_store().raiseChanged()});return i}r.prototype.filterStoreChanged=function(){e.prototype.filterStoreChanged.call(this);var t=Q.trimToNull(this.get_store().get_displayText());this.element.find(".current").toggle(t!=null);this.element.find(".reset").toggle(t!=null);if(t==null)t=Q.text("Controls.FilterPanel.EffectiveEmpty");this.element.find(".txt").text("["+t+"]")};r.prototype.getTemplate=function(){return"<div><a class='reset'></a><a class='edit'></a>"+"<div class='current'><span class='cap'></span>"+"<a class='txt'></a></div></div>"};r=__decorate([t.Decorators.registerClass("Serenity.FilterDisplayBar")],r);return r}(t.FilterWidgetBase);t.FilterDisplayBar=e})(Serenity||(Serenity={}));