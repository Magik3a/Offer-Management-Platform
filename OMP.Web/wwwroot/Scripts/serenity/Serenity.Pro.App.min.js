var Serenity;(function(e){var t=function(){function t(){}i=t;t.prototype.format=function(e){return i.formatValue(e.value)};t.formatValue=function(e){var t=$("<div/>").html(e||"").text();return Q.toSingleLine(t)};t=i=__decorate([e.Decorators.registerFormatter("Serenity.SingleLineTextFormatter")],t);return t;var i}();e.SingleLineTextFormatter=t})(Serenity||(Serenity={}));var Serenity;(function(e){var t=function(t){__extends(i,t);function i(i){var r=t.call(this,i)||this;r._step=1;r.element.children().addClass("wizard-horz");r.wizardGrid=new e.PropertyGrid(r.byId("WizardGrid"),r.getPropertyGridOptions());r.wizardGrid.element.children(".property-tabs").children("li").each(function(e,t){var i=$(t);var r=i.children("a").html();i.html("").attr("data-step",e+1);$('<span class="badge"/>').text(e+1).appendTo(i);$('<span class="text"/>').html(r).appendTo(i);$('<span class="chevron"/>').appendTo(i)});r.byId("CancelButton").click(function(e){return r.confirmCancel(e)});r.byId("BackButton").click(function(){r.moveToStep(r.step-1)});r.byId("NextButton").click(function(){if(!r.validateForm())return false;r.moveToStep(r.step+1)});r.wizardGrid.element.children(".property-tabs").on("click","li",function(e){var t=$(e.currentTarget).data("step");if(t>r.step)return;r.moveToStep(t)});r.wizardGrid.load(r.getInitialEntity());r.element.on("dialogbeforeclose panelbeforeclose",function(t){if(!e.WX.hasOriginalEvent(t))return;r.confirmCancel(t)});return r}i.prototype.getPropertyGridOptions=function(){return{idPrefix:this.idPrefix,mode:1,items:this.getPropertyItems(),localTextPrefix:this.getLocalTextPrefix(),useCategories:true}};i.prototype.getFormKey=function(){return null};i.prototype.getLocalTextPrefix=function(){return""};i.prototype.getPropertyItems=function(){var e=this.getFormKey();if(e)return Q.getForm(e);return[]};i.prototype.getInitialEntity=function(){return{}};Object.defineProperty(i.prototype,"maxSteps",{get:function(){return this.wizardGrid.element.children(".property-tabs").children("li").length},enumerable:true,configurable:true});i.prototype.moveToStep=function(e){if(e==this.step||e<1||e>this.maxSteps+1)return;if(e>=this.maxSteps+1){this.finish();return}(e<this.step?this.back:this.next).call(this,e)};Object.defineProperty(i.prototype,"step",{get:function(){return this._step},set:function(e){this.getStepLink(this._step).removeClass("in active");this.getStepPanel(this._step).removeClass("in active");this.getStepLink(e).addClass("in active");this.getStepPanel(e).addClass("in active").find(".require-layout").triggerHandler("layout");var t;for(t=e;t<=this._step;t++)this.getStepLink(t).removeClass("complete").find("span.badge").removeClass("badge-success");for(t=this._step;t<e;t++)this.getStepLink(t).addClass("complete").find("span.badge").addClass("badge-success");this._step=e;this.byId("BackButton").toggleClass("disabled",this._step<=1);this.byId("NextButton").children(".txt").text(Q.text("Site.WizardDialog."+(this._step==this.maxSteps?"Finish":"Next")+"Button"))},enumerable:true,configurable:true});i.prototype.reset=function(){this.step=1;this.wizardGrid.load(this.getInitialEntity())};i.prototype.finish=function(){this.dialogClose()};i.prototype.next=function(e){this.step=e};i.prototype.back=function(e){this.step=e};i.prototype.getStepLink=function(e){return this.wizardGrid.element.children(".property-tabs").children("li").eq(e-1)};i.prototype.getStepPanel=function(e){return this.wizardGrid.element.children(".property-panes").children().eq(e-1)};i.prototype.getFallbackTemplate=function(){return'\n<div class="s-Form">\n    <form id="~_Form" action="">\n        <div id="~_WizardGrid" class="wizard-grid">\n        </div>\n\n        <div class="buttons" style="text-align: right; margin: 10px 20px;">\n            <button id="~_CancelButton" class="btn btn-danger" formnovalidate><i class="fa fa-ban"></i> Cancel</button>\n            <button id="~_BackButton" class="btn btn-primary disabled" formnovalidate><i class="fa fa-chevron-left"></i> '+Q.text("Site.WizardDialog.BackButton")+'</button>\n            <button id="~_NextButton" class="btn btn-primary" formnovalidate><span class="txt">'+Q.text("Site.WizardDialog.NextButton")+'</span> <i class="fa fa-chevron-right"></i></button>\n        </div>\n    </form>\n</div>'};i.prototype.getCancelMessage=function(){return Q.text("Site.WizardDialog.CancelMessage")};i.prototype.confirmCancel=function(e){var t=this;var i=this.getCancelMessage();if(!i){e.preventDefault();this.dialogClose();return}e.preventDefault();Q.confirm(i,function(){t.dialogClose()})};i.prototype.getSaveEntity=function(e){var t={};this.wizardGrid.save(t);if(e!=null){var i=this.maxSteps;for(var r=1;r<=i;r++){if(e.indexOf(r)>=0)continue;var n=this.getStepPanel(r);n.find(".field").each(function(e,i){var r=$(i).attr("class").split(" ")[1];if(r)delete t[r]})}}return t};Object.defineProperty(i.prototype,"compactSteps",{get:function(){return this.element.children().hasClass("compact-steps")},set:function(e){this.element.children().toggleClass("compact-steps",e)},enumerable:true,configurable:true});return i}(e.TemplatedDialog);e.WizardDialog=t})(Serenity||(Serenity={}));var Serenity;(function(e){var t=function(e){__extends(t,e);function t(){return e!==null&&e.apply(this,arguments)||this}t.prototype.render=function(){var e=this;return React.createElement("div",{className:"card-items"},this.props.items.map(function(t,i){return React.createElement("div",{className:"card-item",key:i},e.props.renderItem(t,i))}))};return t}(React.Component);e.CardViewItems=t})(Serenity||(Serenity={}));var Serenity;(function(e){var t=function(){function t(e){var t=this;this.options=e;var i=this.dataGrid=e.grid;var r=i.getIdProperty();var n=this.getId=function(e){return e[r]};var a=$('\n<div class="btn-group view-switch" data-toggle="buttons" style="float: right">\n    <label class="btn btn-default active" title="'+Q.text("Site.CardViewMixin.ListView")+'">\n        <i class="fa fa-th-list text-purple"></i>\n        <input type="radio" name="'+i.element.attr("id")+'_ViewType" value="list" checked />\n    </label>\n    <label class="btn btn-default" title="'+Q.text("Site.CardViewMixin.CardView")+'">\n        <i class="fa fa-th-large text-purple"></i>\n        <input type="radio" name="'+i.element.attr("id")+'_ViewType" value="card" />    \n    </label>\n</div>').prependTo(i.element.find(".grid-title"));this.cardContainer=$('<div class="card-container" style="display: none;"></div>').insertAfter(i.element.children(".grid-container"));a.find("input").change(function(e){return t.switchView($(e.target).val())});this.resizeCardView();i.element.bind("layout",function(){return t.resizeCardView()});i.view.onDataChanged.subscribe(function(){t.updateCardItems()});var o=i.getCurrentSettings;i.getCurrentSettings=function(e){var t=o.apply(i,[e]);t["viewType"]=a.find("input:checked").val();return t};var l=i.restoreSettings;i.restoreSettings=function(e,t){l.apply(i,[e,t]);if(e==null){var r=this.getPersistanceStorage();if(r==null)return;var n=Q.trimToNull(r.getItem(this.getPersistanceKey()));if(!n)return;e=JSON.parse(n)}var o=e.viewType||"list";var s=a.find("input:checked").val()||"list";if(o!=s){a.find("input").eq(o=="card"?1:0).click()}}}t.prototype.switchView=function(e){this.resizeCardView();var t=e=="card";this.dataGrid.element.children(".card-container").toggle(t);this.dataGrid.element.children(".grid-container").toggle(!t);if(t)this.updateCardItems();this.dataGrid.persistSettings()};t.prototype.updateCardItems=function(){ReactDOM.render(React.createElement(e.CardViewItems,{items:this.dataGrid.getItems(),renderItem:this.options.renderItem}),this.cardContainer[0])};t.prototype.resizeCardView=function(){var e=this.dataGrid.element.children(".grid-container");var t=this.dataGrid.element.width();var i=e.height();this.dataGrid.element.children(".card-container").css({width:t+"px",height:i+"px"})};return t}();e.CardViewMixin=t;Q.initFullHeightGridPage=function(e){$("body").addClass("full-height-page");e.addClass("responsive-height");var t=function(){var t=e.parent().hasClass("page-content")||e.parent().is("section.content");if(t){e.css("height","1px").css("overflow","hidden")}var i=e.children(".card-container");if(i.length&&i.is(":visible")){i.hide();e.children(".grid-container").show();try{Q.layoutFillHeight(e);e.triggerHandler("layout")}finally{e.children(".grid-container").hide();i.show()}}else{Q.layoutFillHeight(e);if(t){e.css("overflow","")}e.triggerHandler("layout")}};if($("body").hasClass("has-layout-event")){$("body").bind("layout",t)}else if(window.Metronic){window.Metronic.addResizeHandler(t)}else{$(window).resize(t)}t();Q.Router.resolve()}})(Serenity||(Serenity={}));var Serenity;(function(e){var t=function(){function e(e){var t=this;this.options=e;var i=this.dataGrid=e.grid;var r=i.getIdProperty();var n=this.getId=function(e){return e[r]};var a=$('\n<div class="dropdown favorite-views" style="float: right">\n  <button class="btn btn-default dropdown-toggle" type="button" id="'+i.element.attr("id")+'_Favorites" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">\n    <i class="fa fa-star text-blue"></i> '+Q.text("Site.FavoriteViewsMixin.FavoriteViews")+'\n    <span class="caret"></span>\n  </button>\n  <ul class="dropdown-menu" aria-labelledby="dropdownMenu1">\n    <li class="save">\n        <div>'+Q.text("Site.FavoriteViewsMixin.SaveView")+'</div>\n        <div><input type="text"></div>\n        <div><button class="btn btn-primary save-button"><i class="fa fa-floppy-o"></i> '+Q.text("Site.FavoriteViewsMixin.SaveButton")+"</button></div>\n    </li>\n  </ul>\n</div>\n").prependTo(i.element.find(".grid-title"));a.on("shown.bs.dropdown",function(e){a.find("input[type=text]").focus()});var o=a.find("li.save input[type=text]");a.find("button.save-button").click(function(){var e=Q.trimToNull(o.val());if(!e){Q.notifyWarning(Q.text("Site.FavoriteViewsMixin.EmptyNameError"));return}var r=t.getFavorites();r[e]=i.getCurrentSettings();t.saveFavorites(r);Q.notifySuccess(Q.format(Q.text("Site.FavoriteViewsMixin.SaveSuccessMessage"),e));o.val("");t.populateFavorites()});this.ul=a.children("ul");this.ul.on("click","i.fa-trash-o",function(e){var i=$(e.target).closest("li").children("a").text();var r=t.getFavorites();delete r[i];t.saveFavorites(r);t.populateFavorites();Q.notifyWarning(Q.format(Q.text("Site.FavoriteViewsMixin.DeleteSuccessMessage"),i))});this.ul.on("click","a",function(e){var r=$(e.target).text();var n=t.getFavorites();var a=n[r];if(a){i.restoreSettings(a);i.refresh();Q.notifySuccess(Q.format(Q.text("Site.FavoriteViewsMixin.LoadedViewMessage"),r))}});this.populateFavorites()}e.prototype.populateFavorites=function(){var e=this.getFavorites();var t=this.ul.children(".save");this.ul.children().not(t).remove();var i=Object.keys(e).sort();if(i.length){for(var r=0,n=i;r<n.length;r++){var a=n[r];var o=$('<li class="fav"><a href="javascript:;"></a></li>').insertBefore(t).children("a").text(a).end();$('<i class="fa fa-trash-o pull-right"></i>').attr("title",Q.text("Site.FavoriteViewsMixin.DeleteButtonHint")).appendTo(o)}$('<li role="separator" class="divider"></li>').insertBefore(t)}};e.prototype.saveFavorites=function(e){var t=this.dataGrid.getPersistanceStorage();var i="Views:"+this.dataGrid.getPersistanceKey();t.setItem(i,JSON.stringify(e))};e.prototype.getFavorites=function(){var e=this.dataGrid.getPersistanceStorage();var t="Views:"+this.dataGrid.getPersistanceKey();return JSON.parse(e.getItem(t)||"{}")||{}};return e}();e.FavoriteViewsMixin=t})(Serenity||(Serenity={}));var Serenity;(function(e){function t(t){switch(t){case e.SummaryType.Sum:return Slick.Aggregators.Sum;case e.SummaryType.Avg:return Slick.Aggregators.Avg;case e.SummaryType.Max:return Slick.Aggregators.Max;case e.SummaryType.Min:return Slick.Aggregators.Min}return null}var i=function(){function i(i){var r=i.grid;var n=function(){var i=r["allColumns"];var n=[];for(var a=0,o=i;a<o.length;a++){var l=o[a];if(l.sourceItem==null)continue;if(l.sourceItem.summaryType!=null&&l.sourceItem.summaryType!=e.SummaryType.Disabled){var s=t(l.sourceItem.summaryType);if(s==null)continue;l.summaryType=l.sourceItem.summaryType;n.push(new s(l.field))}}return n};r.view.setSummaryOptions({aggregators:n()});var a=$('<ul class="s-AggregatesPopup" \n                style="display:none;position:absolute;z-index:100000;">\n                <li data-agg="1">Sum</li>\n                <li data-agg="2">Average</li>\n                <li data-agg="3">Min</li>\n                <li data-agg="4">Max</li>\n            </ul>').appendTo(document.body).click(function(i){if(!$(i.target).is("li"))return;var n=a.data("column");if(n==null||!n.id)return;var o=Q.tryFirst(r["allColumns"],function(e){return e.id==n.id});if(!o)return;if(o.sourceItem==null||o.sourceItem.summaryType==null||o.sourceItem.summaryType==e.SummaryType.Disabled)return;var l=Q.toId($(i.target).data("agg"));if(l===o.summaryType)return;o.summaryType=l;var s=r["allColumns"].filter(function(e){return e.summaryType}).map(function(e){var i=t(e.summaryType);if(i==null)return null;return new i(e.field)}).filter(function(e){return e!=null});r.view.setSummaryOptions({aggregators:s});var u=r.view.getGrouping();for(var d=0;d<u.length;d++)u[d].aggregators=s;r.view.setGrouping(u);r.slickGrid.invalidate()});r.element.on("click",".slick-footerrow-column",function(t){t.preventDefault();var i=$(t.currentTarget).data("column");if(!i||!i.id)return;var n=Q.tryFirst(r["allColumns"],function(e){return e.id==i.id});if(!n)return;if(!n||!n.sourceItem||n.sourceItem.summaryType==null||n.sourceItem.summaryType==e.SummaryType.Disabled)return;a.data("column",n).show().css("top",t.pageY-a.height()+"px").css("left",t.pageX+"px").children("li").removeClass("active").end().children("li[data-agg="+n.summaryType+"]").addClass("active");$(document.body).off("click.aggregatesMenu"+r["uniqueName"]);window.setTimeout(function(){return $(document.body).on("click.aggregatesMenu"+r["uniqueName"],function(){a.hide();$(document.body).off("click.aggregatesMenu"+r["uniqueName"])})},1)});var o=r.getCurrentSettings;r.getCurrentSettings=function(e){var t=o.apply(r,[e]);return t};var l=r.restoreSettings;r.restoreSettings=function(e,t){l.apply(r,[e,t])}}return i}();e.CustomSummaryMixin=i})(Serenity||(Serenity={}));var Slick;(function(e){var t;(function(t){var i=function(){function t(t){this.onGroupChanged=new e.Event;var i={};this.options=$.extend(true,{},i,t)}t.prototype.init=function(e){this.grid=e;this.gridUid=e["getUID"]();this.dropbox=$(e["getGroupingPanel"]());var t=this.options.dropPlaceHolderText||Q.tryGetText("Site.DraggableGroupingMixin.DropPlaceholder")||"Drag a column header here to group by that column";this.dropbox.html("<div class='slick-dropped-placeholder'>"+t+"</div>"+('<div class="slick-group-expand-all" title="'+(Q.tryGetText("Site.DraggableGrupingMixin.ExpandAllButton")||"Expand All")+'" style="display:none"></div>')+('<div class="slick-group-collapse-all" title="'+(Q.tryGetText("Site.DraggableGrupingMixin.CollapseAllButton")||"Collapse All")+'" style="display:none"></div>'));this.dropboxPlaceholder=this.dropbox.find(".slick-dropped-placeholder");this.expandAll=this.dropbox.find(".slick-group-expand-all");this.collapseAll=this.dropbox.find(".slick-group-collapse-all");this.setupColumnDropbox();var i=this.getColumns();for(var r=0;r<i.length;r++){var n=i[r];e["updateColumnHeader"](n.id)}this.columnsGroupBy=[]};t.prototype.getColumns=function(){return this.options.getAllColumns&&this.options.getAllColumns()||this.grid.getColumns()};t.prototype.destroy=function(){this.onGroupChanged.clear()};t.prototype.setupColumnDropbox=function(){var e=this;var t=this;this.dropbox.droppable({activeClass:"ui-state-default",hoverClass:"ui-state-hover",accept:":not(.ui-sortable-helper)",deactivate:function(t,i){e.dropbox.removeClass("slick-header-column-denied")},drop:function(e,i){t.handleGroupByDrop(this,i.draggable.attr("id").replace(t.gridUid,""))},over:function(t,i){var r=i.draggable.attr("id").replace(e.gridUid,"");e.getColumns().forEach(function(t,i,n){if(t.id==r){if(t.grouping!==false){e.dropbox.addClass("slick-header-column-denied")}}})}});this.dropbox.sortable({items:"div.slick-dropped-grouping",cursor:"default",tolerance:"pointer",helper:"clone",update:function(t,i){var r=$(t.target).sortable("toArray",{attribute:"data-id"}),n=[];for(var a=0,o=r.length;a<o;a++){for(var l=0,s=e.columnsGroupBy.length;l<s;l++){if(e.columnsGroupBy[l].id==r[a]){n.push(e.columnsGroupBy[l]);break}}}e.columnsGroupBy=n;e.updateGroupBy()}});this.expandAll.on("click",function(t){e.grid.getData().expandAllGroups()});this.collapseAll.on("click",function(t){e.grid.getData().collapseAllGroups()})};t.prototype.getGroupingFor=function(e){var t=null;if(this.options.getGroupingFor){t=this.options.getGroupingFor(e)}if(t===false)return t;return $.extend({getter:e.field||e.id,formatter:function(t){var i;if(e.formatter){try{i=e.formatter(-1,-1,t.value,e,(n={},n[e.field]=t,n))}catch(r){i=Q.htmlEncode(t.value)}}else i=Q.htmlEncode(t.value);return(e.name||e.field||e.id)+": "+i+" <span style='color:green'>("+t.count+" items)</span>";var n},collapsed:true},t)};t.prototype.handleGroupByDrop=function(e,t){var i=this;var r=true;this.columnsGroupBy.forEach(function(e,i,n){if(e.id==t){r=false}});var n=this.getColumns();if(!r)return;n.forEach(function(r,n,a){if(r.id!==t||r.grouping===false)return;if(r.grouping==null||$.isEmptyObject(r.grouping)){r.grouping=i.getGroupingFor(r);if(r.grouping===false)return}var o=$("<div id='"+i.gridUid+r.id+"_entry' data-id='"+r.id+"' class='slick-dropped-grouping'>");var l=$("<div style='display: inline-flex'>"+r.name+"</div>");l.appendTo(o);var s=$("<div class='slick-groupby-remove'>&nbsp;</div>");if(i.options.deleteIconCssClass)s.addClass(i.options.deleteIconCssClass);if(i.options.deleteIconImage)s.css("background","url("+i.options.deleteIconImage+") no-repeat center right");if(!i.options.deleteIconCssClass&&!i.options.deleteIconImage)s.addClass("slick-groupby-remove-image");s.appendTo(o);$("</div>").appendTo(o);o.appendTo(e);i.addColumnGroupBy(r);i.addGroupByRemoveClickHandler(r.id,e,o)});this.grid.invalidate()};t.prototype.addColumnGroupBy=function(e){this.columnsGroupBy.push(e);this.updateGroupBy()};t.prototype.addGroupByRemoveClickHandler=function(e,t,i){var r=this;$("#"+this.gridUid+e+"_entry >.slick-groupby-remove").one("click",function(){r.removeGroupBy(e,i)})};t.prototype.setDroppedGroups=function(e){if(!e||!e.length){this.columnsGroupBy=[];this.dropbox.find(".slick-dropped-grouping").remove()}else{for(var t=0;t<e.length;t++){this.handleGroupByDrop(this.dropbox,e[t])}}this.updateInterface()};t.prototype.removeGroupBy=function(e,t){t.remove();var i=this.getColumns();var r;while((r=Q.indexOf(this.columnsGroupBy,function(t){return t.id==e}))>=0)this.columnsGroupBy.splice(r,1);this.updateGroupBy()};t.prototype.updateInterface=function(){var e=!!(this.columnsGroupBy&&this.columnsGroupBy.length);this.collapseAll.toggle(e);this.expandAll.toggle(e);this.dropboxPlaceholder.toggle(!e)};t.prototype.updateGroupBy=function(){this.updateInterface();if(this.columnsGroupBy.length==0){this.grid.getData().setGrouping([]);this.onGroupChanged.notify({groupColumns:[]});this.grid.invalidate();return}var e=[];this.columnsGroupBy.forEach(function(t,i,r){e.push(t.grouping)});this.grid.getData().setGrouping(e);this.grid.invalidate();this.onGroupChanged.notify({groupColumns:e})};t.setupColumnReorder=function(e,t,i,r){t.filter(":ui-sortable").sortable("destroy");var n=$(e["getGroupingPanel"]());var a=e.getColumns();var o=e["getUID"]();t.sortable({distance:3,cursor:"default",tolerance:"intersection",helper:"clone",placeholder:"slick-sortable-placeholder ui-state-default slick-header-column",forcePlaceholderSize:true,appendTo:"body",start:function(e,t){$(t.helper).addClass("slick-header-column-active")},beforeStop:function(e,t){$(t.helper).removeClass("slick-header-column-active");var i=n.find(".slick-dropped-grouping").length;if(i>0){n.find(".slick-dropped-placeholder").hide();n.find(".slick-dropped-grouping").show()}},stop:function(n){if(!e["getEditorLock"]().commitCurrentEdit()){$(this).sortable("cancel");return}var l=t.sortable("toArray");var s=[];for(var u=0;u<l.length;u++){s.push(a[e.getColumnIndex(l[u].replace(o,""))])}e.setColumns(s);r(e.onColumnsReordered,{});n.stopPropagation();i()}})};return t}();t.DraggableGrouping=i})(t=e.Plugins||(e.Plugins={}))})(Slick||(Slick={}));var Serenity;(function(e){function t(e,t,i){var r=function(t){return i?i(t[e]):t[e]};return function(e,i){var n=r(e),a=r(i);return(n<a?-1:n>a?1:0)*[1,-1][+!!t]}}var i=function(){function e(e){var i=e.grid;var r=this.plugin=new Slick.Plugins.DraggableGrouping({getAllColumns:function(){return i.allColumns}});i.slickGrid.registerPlugin(r);r.onGroupChanged.subscribe(function(){i.persistSettings(null)});var n=i.getCurrentSettings;i.getCurrentSettings=function(e){var t=n.apply(i,[e]);if(e==null||e.groupColumns==null||e.groupColumns){var r=i.view.getGrouping()||[];t["groupColumns"]=r.map(function(e){return e.getter}).filter(function(e){return e!=null&&typeof e=="string"})}return t};function a(e){if(e==null)return;var t=i.allColumns;var n=e.map(function(e){return Q.tryFirst(t,function(t){return t.id==e})}).filter(function(e){return e!=null});var a=n.map(function(e){if(e["grouping"]==null)e["grouping"]=r.getGroupingFor(e);return e["grouping"]});i.view.setGrouping(a);r.setDroppedGroups(n.map(function(e){return e.id}));i.slickGrid.invalidate()}function o(){var e=i.allColumns.filter(function(e){return e.sourceItem!=null&&e.sourceItem.groupOrder!=null});if(e.length){return e.sort(t("groupOrder")).map(function(e){return e.id})}return null}var l=i.restoreSettings;i.restoreSettings=function(e,t){l.apply(i,[e,t]);if(!(t==null||t.groupColumns==null||t.groupColumns))return;var r=null;if(e==null){var n=this.getPersistanceStorage();if(n!=null){var s=Q.trimToNull(n.getItem(this.getPersistanceKey()));if(s){r=(JSON.parse(s)||{}).groupColumns}}}else r=e.groupColumns;if(r==null){r=o()}a(r)}}return e}();e.DraggableGroupingMixin=i})(Serenity||(Serenity={}));var Slick;(function(e){var t;(function(t){var i=function(){function t(t){this.checkedValues=new window["Set"];this.onFilterApplied=new e.Event;this.onCommand=new e.Event;this.handler=new e.EventHandler;var i={buttonImage:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAA4AAAAOCAYAAAAfSC3RAAAABGdBTUEAALGPC/xhBQAAAAlwSFlzAAALEQAACxEBf2RfkQAAABl0RVh0U29mdHdhcmUAcGFpbnQubmV0IDQuMC4yMfEgaZUAAACeSURBVDhPvdItDsIwGIfxAoZNAQaDmOEgXAIzsRvgCArNCRBcYAmeO+AQHGBuCWqOhYTP521SQsZI2yzhn/xE3+RxVU3WRoSJoz70OpjiiMxijzH0WhhhgzOeP+RIEOA9E6e4oBqdIFGIr0k8xA43mKjADLXR5wY44IEr1rBGZltIWGIuB9f9P1zgDu+whxW8Q1kXS8T65Tn5x6IypV7aOzNezxwrTQAAAABJRU5ErkJggg==",useColumnFormatter:true,getFilterValues:null};this.options=$.extend(true,{},i,t);this.handleMenuItemClick=this.handleMenuItemClick.bind(this)}t.prototype.init=function(e){this.grid=e;this.handler.subscribe(e.onHeaderCellRendered,this.handleHeaderCellRendered.bind(this)).subscribe(e.onBeforeHeaderCellDestroy,this.handleBeforeHeaderCellDestroy.bind(this)).subscribe(e.onClick,this.handleBodyMouseDown.bind(this)).subscribe(e.onColumnsResized,this.columnsResized.bind(this));e.setColumns(e.getColumns());$(document.body).bind("mousedown",this.handleBodyMouseDown=this.handleBodyMouseDown.bind(this))};t.prototype.destroy=function(){this.handler.unsubscribeAll();$(document.body).unbind("mousedown",this.handleBodyMouseDown)};t.prototype.getFilterType=function(e){if(e.headerFilterType!=null)return e.headerFilterType;if(this.options.getFilterType!=null){e.headerFilterType=this.options.getFilterType(e);if(e.headerFilterType!=null)return e.headerFilterType}if(e.headerFilterType==null)e.headerFilterType=1;return e.headerFilterType};t.prototype.handleBodyMouseDown=function(e){if(this.menu&&this.menu[0]!=e.target&&!$.contains(this.menu[0],e.target)){this.hideMenu()}};t.prototype.hideMenu=function(){if(this.menu){this.menu.remove();this.menu=null}};t.prototype.handleHeaderCellRendered=function(e,t){var i=this;var r=t.column;var n=this.getFilterType(r);if(n===0)return false;var a=$("<div></div>").addClass("slick-header-menubutton").data("column",r);if(this.options.buttonImage){a.css("background-image","url("+this.options.buttonImage+")")}$(t.node).addClass("has-header-menubutton");a.on("click",function(e){e.stopPropagation();i.showFilter(e)}).appendTo(t.node)};t.prototype.handleBeforeHeaderCellDestroy=function(e,t){$(t.node).find(".slick-header-menubutton").remove()};t.prototype.addMenuItem=function(e,t,i,r,n){var a=$("<div class='slick-header-menuitem'>").data("command",r).data("column",t).bind("click",this.handleMenuItemClick).appendTo(e);var o=$("<div class='slick-header-menuicon'>").appendTo(a);if(n){o.css("background-image","url("+n+")")}$("<span class='slick-header-menucontent'>").text(i).appendTo(a)};t.prototype.addSearchInput=function(e,t){var i=this;return $("<input class='input' placeholder='"+(Q.tryGetText("Site.HeaderFiltersMixin.Search")||"Search")+"' style='margin-top: 5px; width: 206px'>").data("column",t).bind("keyup",function(e){i.updateFilterValues(t,function(){})}).appendTo(e)};t.prototype.updateFilterItems=function(e){var t=this;var i="<label><input type='checkbox' value='-1' />"+(Q.tryGetText("Site.HeaderFiltersMixin.SelectAll")||"(Select All)")+"</label>";this.checkedValues=new window["Set"](e.headerFilterValues||[]);for(var r=0;r<this.filterValues.length;r++){var n=this.checkedValues.has(this.filterValues[r]);i+="<label><input type='checkbox' value='"+r+"'"+(n?" checked='checked'":"")+"/>"+this.filterTexts[r]+"</label>"}var a=this.menu.find(".filter");a.empty().append($(i));$(":checkbox",a).bind("click",function(e){t.onCheckboxClick($(e.target))})};t.prototype.getFilterText=function(e,t){var i=e[t.field];if(this.options.useColumnFormatter&&t&&t.formatter){try{var r=t.formatter(-1,-1,i,t,e);if(i==null&&r===""){return Q.tryGetText("Site.HeaderFiltersMixin.Null")||"(null)"}return r}catch(n){}}if(i==null)return Q.tryGetText("Site.HeaderFiltersMixin.Null")||"(null)";return Q.htmlEncode(i)};t.prototype.showFilter=function(e){var t=this;var i=$(e.target);var r=i.data("column");this.checkedValues=new window["Set"](r.headerFilterValues||[]);if(!this.menu)this.menu=$("<div class='slick-header-menu cke_dialog'>").appendTo(document.body).hide();else this.menu.empty();this.searchInput=this.addSearchInput(this.menu,r);var n="<label><input type='checkbox' value='-1' />"+(Q.tryGetText("Site.HeaderFiltersMixin.SelectAll")||"(Select All)")+"</label>";var a=$("<div class='filter'>").appendTo(this.menu);$("<button>"+(Q.tryGetText("Site.HeaderFiltersMixin.OkButton")||"OK")+"</button>").appendTo(this.menu).bind("click",function(e){r.headerFilterValues=Array["from"](t.checkedValues);t.setButtonImage(i,r.headerFilterValues.length>0);t.handleApply(e,r)});$("<button>"+(Q.tryGetText("Site.HeaderFiltersMixin.ClearButton")||"Clear")+"</button>").appendTo(this.menu).bind("click",function(e){r.headerFilterValues.length=0;t.setButtonImage(i,false);t.handleApply(e,r)});$("<button>"+(Q.tryGetText("Site.HeaderFiltersMixin.CancelButton")||"Cancel")+"</button>").appendTo(this.menu).bind("click",function(e){return t.hideMenu()});$(":checkbox",a).bind("click",function(e){t.onCheckboxClick($(e.target))});this.updateFilterValues(r,function(){t.menu.show();a.css("height",null);var i=t.menu.height();var r=$(e.target).height();var n=$(e.target).offset();var o=n.left-t.menu.width()+$(e.target).width()-8;var l=n.top+r;var s=$(window).scrollTop();var u=$(window).height()+s;var d=parseInt($("div.content-wrapper").css("padding-top"),10)||0;if(l+i>u&&u-l+d<l-s){l-=i+r+8;if(l<s)l=s}var c=l+i-u;if(c>0){a.css("height",a.height()-c)}t.menu.css("top",l).css("left",o>0?o:0)})};t.prototype.columnsResized=function(){this.hideMenu()};t.prototype.onCheckboxClick=function(e){var t=e.val();var i=e.parent().parent();if(e.val()<0){if(e.prop("checked")){$(":checkbox",i).prop("checked",true);this.checkedValues=new window["Set"](this.filterValues||[])}else{$(":checkbox",i).prop("checked",false);this.checkedValues.clear()}}else{var r=this.filterValues[t];var n=this.checkedValues.has(r);if(e.prop("checked")&&!n){this.checkedValues.add(r)}else if(n){this.checkedValues.delete(r)}}};t.prototype.setButtonImage=function(e,t){e.toggleClass("is-filtered",t)};t.prototype.handleApply=function(e,t){this.hideMenu();this.onFilterApplied.notify({grid:this.grid,column:t},e,this);e.preventDefault();e.stopPropagation()};t.prototype.containsFilter=function(e){if(e==null&&e.length==0)return function(e){return true};var t=Q.htmlEncode(e).toLowerCase();return function(e){e=Q.coalesce(e,"").toString().replace(/<[^>]+>/g,"").toLowerCase();return e.indexOf(t)>=0}};t.prototype.getFilterValue=function(e,t){var i=e[t.field];if(this.options.useColumnFormatter&&t.formatter!=null&&t.headerFilterType==2){return this.getFilterText(e,t).replace(/<[^>]+>/g,"")}return i};t.prototype.sortFilterValues=function(){var e=this;var t=[];for(var i=0;i<this.filterValues.length;i++){t[i]=i}t.sort(function(t,i){var r=e.filterValues[t];var n=e.filterValues[i];return r<n?-1:r>n?1:0});var r=[];var n=[];for(var i=0;i<t.length;i++){r.push(this.filterValues[i]);n.push(this.filterTexts[i])}this.filterValues=r;this.filterTexts=n};t.prototype.updateFilterValues=function(e,t){var i=this;if(this.options.getFilterValues!=null){this.options.getFilterValues(e,function(r,n){if(r==null){i.updateFilterValuesFromData(e);i.updateFilterItems(e);t()}else{i.filterValues=[];i.filterTexts=[];n=n||r.map(function(t){var r={};r[e.field]=t;return i.getFilterText(r,e)});var a=i.containsFilter(i.searchInput.val());i.filterValues=r.filter(function(e,t){if(a(n[t])){i.filterTexts.push(n[t]);return true}return false});i.sortFilterValues();i.updateFilterItems(e);t()}})}else{this.updateFilterValuesFromData(e);this.updateFilterItems(e);t()}};t.prototype.updateFilterValuesFromData=function(e){this.filterValues=[];this.filterTexts=[];var t=this.grid.getData();var i;if(this.checkedValues&&this.checkedValues.size){i=t.getItems()}else{i=[];for(var r=0;r<t.getLength();r++){i.push(t.getItem(r))}}var n=new window["Set"];var a=this.searchInput.val();var o=this.containsFilter(a);for(var l=0,s=i;l<s.length;l++){var u=s[l];var d=this.getFilterValue(u,e);if(!n.has(d)){var c=this.getFilterText(u,e);if(o(c)){n.add(d);this.filterValues.push(d);this.filterTexts.push(c)}}}this.sortFilterValues()};t.prototype.handleMenuItemClick=function(e){var t=$(this).data("command");var i=$(this).data("column");this.hideMenu();this.onCommand.notify({grid:this,column:i,command:t},e,this);e.preventDefault();e.stopPropagation()};return t}();t.HeaderFilters=i})(t=e.Plugins||(e.Plugins={}))})(Slick||(Slick={}));var Serenity;(function(e){var t=function(){function t(t){var i=this;var r=null;var n={};if(t.filterByText==null){this.filterByText=!t.grid.view.url||!t.grid.view["getPagingInfo"]().rowsPerPage}else this.filterByText=!!t.filterByText;var a=new Slick.Plugins.HeaderFilters({getFilterType:function(e){if(i.filterByText)return 2;if(e.sortable!=null&&!e.sortable)return 0;if(e.sourceItem!=null&&e.sourceItem.notFilterable!=null&&e.sourceItem.notFilterable)return 0;return 1},getFilterValues:function(e,i){if(e.headerFilterType==2)return i(null);r=e;try{if(!t.grid.onViewSubmit()){i([]);return}}finally{r=null}var a=Q.deepClone(t.grid.view.params);a.DistinctFields=[e.field];a.Skip=0;a.Take=0;var o=$.toJSON(a);var l=n[o];if(l&&l.expires>(new Date).getTime())i(l.value);else{Q.serviceCall({request:a,url:t.grid.view.url,onSuccess:function(e){n[o]={value:e.Values,expires:(new Date).getTime()+1e3*30};i(e.Values)}})}}});a.onFilterApplied.subscribe(function(e,i){var r=i.column;if(r&&r.headerFilterType==2)t.grid.view.setItems(t.grid.view.getItems(),true);else t.grid.refresh()});t.grid.slickGrid.registerPlugin(a);var o=this;var l=t.grid.onViewSubmit;t.grid.onViewSubmit=function(){if(!l.call(this))return false;var t=this.slickGrid.getColumns();var i=this.view.params;for(var n=0,a=t;n<a.length;n++){var o=a[n];
if(o===r||o.headerFilterType==2)continue;var s=o.headerFilterValues;if(s&&s.length){var u=s.filter(function(e){return e!=null});var d=[[o.field],"in",[u]];if(u.length!==s.length){if(u.length>0)d=e.Criteria.or(["is null",[o.field]],d);else d=["is null",[o.field]]}i.Criteria=e.Criteria.and(i.Criteria,d)}}return true};var s=t.grid.onViewFilter;t.grid.onViewFilter=function(e){if(!s.apply(this,arguments))return false;var t=this.slickGrid.getColumns();for(var i=0,r=t;i<r.length;i++){var n=r[i];if(n.headerFilterType!=2)continue;var o=n.headerFilterValues;if(o&&o.length){var l=a.getFilterValue(e,n);if(o.indexOf(l)<0)return false}}return true}}return t}();e.HeaderFiltersMixin=t})(Serenity||(Serenity={}));